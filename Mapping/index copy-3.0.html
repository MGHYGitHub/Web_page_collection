<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è“è†œ Mapping å·¥å…· - å·¥ä¸šåŒ–ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      background: linear-gradient(135deg, #c3d1ff, #f5f7fa);
      overflow-x: hidden;
      position: relative;
    }

    .main-container {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 20px;
      max-width: 1600px;
      margin: 0 auto;
      min-height: calc(100vh - 60px);
    }

    /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
    .control-panel {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 25px;
      width: 320px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex-shrink: 0;
    }

    .control-panel h2 {
      margin: 0 0 15px 0;
      color: #222;
      font-size: 24px;
      text-align: center;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-group h3 {
      margin: 0;
      color: #444;
      font-size: 16px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .control-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      background: #5c6bc0;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
    }

    .control-btn:hover {
      background: #3f51b5;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .control-btn.settings {
      background: #ff9800;
    }

    .control-btn.settings:hover {
      background: #f57c00;
    }

    .control-btn.lock {
      background: #9c27b0;
    }

    .control-btn.lock:hover {
      background: #7b1fa2;
    }

    .control-btn.danger {
      background: #f44336;
    }

    .control-btn.danger:hover {
      background: #d32f2f;
    }

    .control-btn.success {
      background: #4caf50;
    }

    .control-btn.success:hover {
      background: #388e3c;
    }

    .control-btn.info {
      background: #2196f3;
    }

    .control-btn.info:hover {
      background: #1976d2;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
    }

    .file-input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    /* ä¸­é—´çŸ©é˜µåŒºåŸŸ */
    .matrix-area {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
      display: flex;
      flex-direction: column;
      position: relative;
      min-width: 0; /* é‡è¦ï¼šå…è®¸å†…å®¹æº¢å‡º */
    }

    .matrix-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .matrix-header h2 {
      color: #222;
      margin-bottom: 10px;
    }

    .summary {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      padding: 10px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      margin-bottom: 15px;
      flex-shrink: 0;
    }

    #matrix-container {
      flex: 1;
      overflow: auto;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.3);
      padding: 10px;
      position: relative;
      min-height: 400px;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    #matrix-container::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    #matrix-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 5px;
    }

    #matrix-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    #matrix-container::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    #matrix {
      display: grid;
      gap: 2px;
      user-select: none;
      margin: 0 auto;
      width: max-content; /* é‡è¦ï¼šç¡®ä¿ç½‘æ ¼å¯ä»¥è¶…è¿‡å®¹å™¨å®½åº¦ */
    }

    .cell {
      text-align: center;
      line-height: 30px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.5);
      transition: all 0.2s;
      width: var(--cell-size);
      height: var(--cell-size);
      line-height: var(--cell-size);
      position: relative;
      cursor: pointer;
    }

    :root {
      --cell-size: 30px;
    }

    .bin-1 {
      background-color: #4caf50;
      color: white;
    }

    .bin-2 {
      background-color: #f44336;
      color: white;
    }

    .bin-other {
      background-color: #2196f3;
      color: white;
    }

    .selected {
      outline: 3px solid #ff9800;
      outline-offset: -1px;
      z-index: 10;
    }

    /* é€‰æ‹©æ¡†æ ·å¼ - ä¿®å¤ */
    .selection-box {
      position: absolute;
      border: 2px dashed #ff9800;
      background-color: rgba(255, 152, 0, 0.1);
      pointer-events: none;
      z-index: 5;
      display: none;
      box-sizing: border-box;
    }

    /* å³ä¾§è´´è¾¹å…¬å‘Šæ  */
    .announcement-sidebar {
      position: fixed;
      right: 0;
      top: 10px; /* å¾€ä¸Šæä¸€ç‚¹ */
      bottom: 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
    }

    .announcement-toggle {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 12px;
      border-radius: 12px 0 0 12px;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: -4px 0 15px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-right: none;
      height: auto;
      min-height: 120px;
      transition: all 0.3s ease;
    }

    .announcement-toggle:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      transform: translateX(-5px);
      box-shadow: -6px 0 20px rgba(0, 0, 0, 0.2);
    }

    .announcement-content {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 12px 0 0 12px;
      padding: 25px;
      box-shadow: -4px 0 25px rgba(0, 0, 0, 0.2);
      width: 300px;
      display: none;
      flex-direction: column;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-right: none;
      overflow-y: auto;
      max-height: 80vh;
      margin-left: -1px;
    }

    .announcement-content.show {
      display: flex;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .announcement-header h3 {
      color: #222;
      margin: 0;
      font-size: 18px;
    }

    .close-announcement {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
      transition: color 0.2s;
    }

    .close-announcement:hover {
      color: #333;
    }

    .announcement-content p {
      margin: 10px 0;
      color: #444;
      line-height: 1.5;
      font-size: 14px;
    }

    .announcement-content ul {
      padding-left: 20px;
      margin: 10px 0;
    }

    .announcement-content li {
      margin: 5px 0;
      color: #444;
      line-height: 1.5;
    }

    .announcement-content .warning {
      color: #f44336;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: rgba(244, 67, 54, 0.1);
      border-radius: 8px;
      border-left: 4px solid #f44336;
      font-size: 13px;
    }

    .got-it-btn {
      width: 100%;
      padding: 12px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
      transition: all 0.2s;
    }

    .got-it-btn:hover {
      background: #388e3c;
    }

    /* é¡µè„š */
    .footer {
      grid-column: 1 / -1;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
      color: #666;
      font-size: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .footer a {
      color: #5c6bc0;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* å³é”®èœå• */
    #context-menu {
      position: fixed;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 10px 0;
      display: none;
      z-index: 1000;
      min-width: 180px;
    }

    .menu-item {
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .menu-item:hover {
      background-color: #e0e0e0;
    }

    .menu-divider {
      height: 1px;
      background-color: #ccc;
      margin: 5px 0;
    }

    /* æ¨¡æ€æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      min-width: 400px;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      margin: 0;
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      transition: color 0.2s;
    }

    .close-btn:hover {
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }

    .form-group input[type="number"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 30px;
    }

    .form-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #5c6bc0;
      color: white;
    }

    .btn-primary:hover {
      background: #3f51b5;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    /* çŠ¶æ€æ¶ˆæ¯ */
    .status-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      max-width: 80%;
      text-align: center;
    }

    .status-success {
      background-color: #4caf50;
    }

    .status-error {
      background-color: #f44336;
    }

    .status-info {
      background-color: #2196f3;
    }

    .status-warning {
      background-color: #ff9800;
    }

    /* ä¿æŠ¤å•å…ƒæ ¼æ ·å¼ */
    .protected {
      opacity: 0.7;
      cursor: not-allowed !important;
      position: relative;
      background-color: #f0f0f0 !important;
    }

    .protected::after {
      content: "ğŸ”’";
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 10px;
    }

    .protected.bin-1 {
      background-color: #c8e6c9 !important;
      color: #666;
    }

    .protected.bin-2 {
      background-color: #ffcdd2 !important;
      color: #666;
    }

    .protected.selected {
      outline: none !important;
    }

    /* æ€§èƒ½ä¼˜åŒ–ï¼šå•å…ƒæ ¼æ¸²æŸ“æŒ‡ç¤ºå™¨ */
    .rendering-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 100;
      display: none;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      
      .control-panel {
        width: 100%;
      }
      
      .announcement-sidebar {
        right: 10px;
        top: auto;
        bottom: 20px;
      }
      
      .announcement-toggle {
        padding: 15px 10px;
        min-height: 100px;
      }
      
      .announcement-content {
        width: 280px;
        max-height: 60vh;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .modal-content {
        min-width: 90%;
        margin: 20px;
      }
      
      .matrix-area {
        padding: 15px;
      }
      
      /* ç§»åŠ¨ç«¯éšè—å…¬å‘Šæ ï¼Œæ˜¾ç¤ºæµ®åŠ¨æŒ‰é’® */
      .announcement-sidebar {
        display: none;
      }
      
      .mobile-announcement-btn {
        display: block !important;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1001;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }
    }

    /* ç§»åŠ¨ç«¯å…¬å‘ŠæŒ‰é’® */
    .mobile-announcement-btn {
      display: none;
    }
  </style>
</head>

<body>
  <!-- ä¸»è¦åº”ç”¨å®¹å™¨ -->
  <div class="main-container">
    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
      <h2>è“è†œ Mapping æ§åˆ¶å°</h2>
      
      <div class="control-group">
        <h3>ğŸ“ çŸ©é˜µè®¾ç½®</h3>
        <button class="control-btn" onclick="showMatrixSettings()">
          <span>ğŸ“</span> è®¾ç½®çŸ©é˜µå°ºå¯¸
        </button>
        <button class="control-btn settings" onclick="showSettingsModal()">
          <span>âš™ï¸</span> ç³»ç»Ÿè®¾ç½®
        </button>
      </div>
      
      <div class="control-group">
        <h3>ğŸ“ æ–‡ä»¶æ“ä½œ</h3>
        <div class="file-input-wrapper">
          <button class="control-btn info">
            <span>ğŸ“‚</span> å¯¼å…¥ Excel æ–‡ä»¶
          </button>
          <input type="file" id="upload" class="file-input" accept=".xlsx, .xls, .csv" />
        </div>
        <button class="control-btn" onclick="loadSourceFile()">
          <span>ğŸ”„</span> è‡ªåŠ¨è·å–æºæ–‡ä»¶
        </button>
        <button class="control-btn" onclick="downloadTemplate()">
          <span>ğŸ“¥</span> ä¸‹è½½æ¨¡æ¿
        </button>
        <button class="control-btn" onclick="exportToExcel()">
          <span>ğŸ“Š</span> å¯¼å‡º Excel
        </button>
      </div>
      
      <div class="control-group">
        <h3>ğŸ¨ å•å…ƒæ ¼æ“ä½œ</h3>
        <button class="control-btn success" onclick="setBin(1)">
          <span>âœ…</span> è®¾ç½®ä¸ºæœ‰æ–™ (<span id="bin1-display">1</span>)
        </button>
        <button class="control-btn danger" onclick="setBin(2)">
          <span>âŒ</span> è®¾ç½®ä¸ºæ— æ–™ (<span id="bin2-display">2</span>)
        </button>
        <button class="control-btn" onclick="searchCell()">
          <span>ğŸ”</span> æœç´¢å®šä½
        </button>
      </div>
      
      <div class="control-group">
        <h3>ğŸ”§ è§†å›¾æ§åˆ¶</h3>
        <button class="control-btn" onclick="updateCellSize(5)">
          <span>â•</span> æ”¾å¤§å•å…ƒæ ¼
        </button>
        <button class="control-btn" onclick="updateCellSize(-5)">
          <span>â–</span> ç¼©å°å•å…ƒæ ¼
        </button>
        <button id="lock-toggle" class="control-btn lock" onclick="toggleLock()">
          <span>ğŸ”“</span> å¯ç¼–è¾‘æ¨¡å¼
        </button>
        <button class="control-btn" onclick="clearAllSelections()">
          <span>ğŸ—‘ï¸</span> æ¸…ç©ºé€‰æ‹©
        </button>
      </div>
    </div>
    
    <!-- ä¸­é—´çŸ©é˜µåŒºåŸŸ -->
    <div class="matrix-area">
      <div class="matrix-header">
        <h2>è“è†œçŸ©é˜µ Mapping è§†å›¾</h2>
        <div class="summary" id="summary">
          æœ‰æ–™ (<span id="bin1-value">1</span>)ï¼š0ï¼Œ æ— æ–™ (<span id="bin2-value">2</span>)ï¼š0ï¼Œ æ€»æ•°ï¼š0
        </div>
      </div>
      <div id="matrix-container">
        <!-- æ¸²æŸ“æŒ‡ç¤ºå™¨ -->
        <div id="rendering-indicator" class="rendering-indicator">æ­£åœ¨æ¸²æŸ“çŸ©é˜µ...</div>
        <div id="matrix"></div>
        <!-- é€‰æ‹©æ¡† -->
        <div id="selection-box" class="selection-box"></div>
      </div>
    </div>
    
    <!-- é¡µè„š -->
    <div class="footer">
      <p>
        ğŸ” é˜²ä¼ªæ ‡è¯†ï¼šTIA-MAP-2025-PRO | 
        ğŸ‘¨â€ğŸ’» å¼€å‘è€…ï¼šå»–å­å®¸ | 
        ğŸ“§ æŠ€æœ¯æ”¯æŒï¼š<a href="mailto:example@example.com">example@example.com</a>
      </p>
      <p>Â© 2025 è“è†œ Mapping å·¥å…· v3.0.0 å·¥ä¸šåŒ–ç‰ˆ - ç‰ˆæƒæ‰€æœ‰</p>
    </div>
  </div>

  <!-- å³ä¾§è´´è¾¹å…¬å‘Šæ  -->
  <div class="announcement-sidebar">
    <div class="announcement-toggle" onclick="toggleAnnouncement()">
      ğŸ“¢ ç³»ç»Ÿå…¬å‘Š
    </div>
    <div class="announcement-content" id="announcement-content">
      <div class="announcement-header">
        <h3>è“è†œ Mapping å·¥å…· v3.0</h3>
        <button class="close-announcement" onclick="closeAnnouncement()">Ã—</button>
      </div>
      <p>æ¬¢è¿ä½¿ç”¨è“è†œçŸ©é˜µMappingä¸“ä¸šå·¥å…·ï¼</p>
      <p>æœ¬å·¥å…·æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p>
      <ul>
        <li>Excelæ•°æ®å¯¼å…¥å¯¼å‡º</li>
        <li>æ™ºèƒ½æ¡†é€‰ä¸å¤šé€‰</li>
        <li>è‡ªå®šä¹‰çŸ©é˜µå°ºå¯¸</li>
        <li>è‡ªå®šä¹‰æœ‰æ–™/æ— æ–™æ•°å€¼</li>
        <li>å³é”®èœå•å¿«æ·æ“ä½œ</li>
        <li>çŠ¶æ€ç®¡ç†ä¸ä¿æŠ¤å•å…ƒæ ¼</li>
      </ul>
      <div class="warning">
        âš ï¸ æ³¨æ„ï¼šè¯·å‹¿éšæ„ä¿®æ”¹å—ä¿æŠ¤çš„å•å…ƒæ ¼
      </div>
      <button class="got-it-btn" onclick="closeAnnouncement()">
        æˆ‘çŸ¥é“äº†
      </button>
    </div>
  </div>
  
  <!-- ç§»åŠ¨ç«¯å…¬å‘ŠæŒ‰é’® -->
  <div class="mobile-announcement-btn" onclick="toggleAnnouncement()">
    ğŸ“¢
  </div>

  <!-- å³é”®èœå• -->
  <div id="context-menu">
    <div class="menu-item" onclick="setBinFromMenu(1)">
      <span style="color:#4caf50">â—</span> è®¾ç½®ä¸ºæœ‰æ–™ (<span id="context-bin1">1</span>)
    </div>
    <div class="menu-item" onclick="setBinFromMenu(2)">
      <span style="color:#f44336">â—</span> è®¾ç½®ä¸ºæ— æ–™ (<span id="context-bin2">2</span>)
    </div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="loadSourceFile()">
      <span>ğŸ”„</span> è‡ªåŠ¨è·å–æºæ–‡ä»¶
    </div>
    <div class="menu-item" onclick="document.getElementById('upload').click()">
      <span>ğŸ“</span> é€‰æ‹©æ–‡ä»¶...
    </div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="clearAllSelections()">
      <span>ğŸ—‘ï¸</span> æ¸…ç©ºé€‰æ‹©
    </div>
    <div class="menu-item" onclick="showMatrixSettings()">
      <span>ğŸ“</span> è°ƒæ•´çŸ©é˜µå°ºå¯¸
    </div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="hideContextMenu()">
      <span>âœ•</span> å–æ¶ˆ
    </div>
  </div>

  <!-- è®¾ç½®æ¨¡æ€æ¡† -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
        <button class="close-btn" onclick="hideSettingsModal()">Ã—</button>
      </div>
      
      <div class="form-group">
        <label>æœ‰æ–™å•å…ƒæ ¼æ•°å€¼ï¼š</label>
        <input type="number" id="bin1-input" min="0" max="99" value="1">
        <div style="margin-top: 5px; font-size: 12px; color: #666;">
          é¢œè‰²ï¼š<span style="color:#4caf50">â— ç»¿è‰²</span>
        </div>
      </div>
      
      <div class="form-group">
        <label>æ— æ–™å•å…ƒæ ¼æ•°å€¼ï¼š</label>
        <input type="number" id="bin2-input" min="0" max="99" value="2">
        <div style="margin-top: 5px; font-size: 12px; color: #666;">
          é¢œè‰²ï¼š<span style="color:#f44336">â— çº¢è‰²</span>
        </div>
      </div>
      
      <div class="form-group">
        <label>å…¶ä»–çŠ¶æ€æ•°å€¼ï¼š</label>
        <input type="number" id="other-bin-input" min="0" max="99" value="0">
        <div style="margin-top: 5px; font-size: 12px; color: #666;">
          é¢œè‰²ï¼š<span style="color:#2196f3">â— è“è‰²</span>
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="hideSettingsModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <!-- çŸ©é˜µå°ºå¯¸è®¾ç½®æ¨¡æ€æ¡† -->
  <div id="matrix-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“ è®¾ç½®çŸ©é˜µå°ºå¯¸</h3>
        <button class="close-btn" onclick="hideMatrixModal()">Ã—</button>
      </div>
      
      <div class="form-group">
        <label>è¡Œæ•° (æœ€å¤§100è¡Œ)ï¼š</label>
        <input type="number" id="rows-input" min="1" max="100" value="10">
      </div>
      
      <div class="form-group">
        <label>åˆ—æ•° (æœ€å¤§100åˆ—)ï¼š</label>
        <input type="number" id="cols-input" min="1" max="100" value="10">
      </div>
      
      <div class="form-group">
        <label>æ€§èƒ½æç¤ºï¼š</label>
        <div style="margin-top: 5px; font-size: 12px; color: #f44336;">
          âš ï¸ æ³¨æ„ï¼šè®¾ç½®è¿‡å¤§å°ºå¯¸ï¼ˆå¦‚100Ã—100ï¼‰å¯èƒ½å½±å“æ€§èƒ½ï¼Œå»ºè®®ä½¿ç”¨è¾ƒå°å•å…ƒæ ¼å°ºå¯¸
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" onclick="hideMatrixModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="applyMatrixSize()">åº”ç”¨å°ºå¯¸</button>
      </div>
    </div>
  </div>

  <script>
    // é»˜è®¤æºæ–‡ä»¶è·¯å¾„
    const SOURCE_FILE_URL = './TIA.xlsx';

    // æ ¸å¿ƒæ•°æ®
    let matrixData = {};
    let validPositions = new Set();
    let selectedCells = new Set();
    let isSelecting = false;
    let startCell = null;
    let isAddingSelection = false;
    let maxRow = 9, maxCol = 9;
    let cellSize = 30;
    let isLocked = false;
    let protectedPositions = new Set();
    
    // è‡ªå®šä¹‰è®¾ç½®
    let customBin1 = 1;
    let customBin2 = 2;
    let customOtherBin = 0;

    // å…¬å‘ŠçŠ¶æ€
    let announcementShown = localStorage.getItem('announcementShown') === 'true';

    // é€‰æ‹©æ¡†ç›¸å…³
    let selectionBox = null;
    let lastMousePos = null;

    // æ€§èƒ½ä¼˜åŒ–ï¼šæ¸²æŸ“æ‰¹å¤„ç†
    let renderBatchSize = 1000; // æ¯æ¬¡æ¸²æŸ“çš„å•å…ƒæ ¼æ•°é‡
    let renderTimeout = null;

    // äº‹ä»¶ç›‘å¬
    document.getElementById('upload').addEventListener('change', handleFile);
    document.addEventListener('mouseup', handleMouseUp);
    document.addEventListener('contextmenu', handleContextMenu);
    document.addEventListener('click', hideContextMenu);
    
    // ä½¿ç”¨æ–‡æ¡£çº§é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼Œè€Œä¸æ˜¯å•å…ƒæ ¼çº§
    document.addEventListener('mousemove', handleMouseMove);

    // åˆå§‹åŒ–
    window.onload = () => {
      loadFromLocalStorage();
      updateBinDisplays();
      createSelectionBox();
      
      // æ ¹æ®æœ¬åœ°å­˜å‚¨çŠ¶æ€æ˜¾ç¤º/éšè—å…¬å‘Š
      if (!announcementShown) {
        setTimeout(() => {
          showAnnouncement();
        }, 1000);
      }
    };

    function createSelectionBox() {
      selectionBox = document.getElementById('selection-box');
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        processFileData(evt.target.result);
      };
      reader.readAsArrayBuffer(file);
    }

    function processFileData(arrayBuffer) {
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

      matrixData = {};
      validPositions.clear();
      protectedPositions.clear();
      maxRow = 0;
      maxCol = 0;

      json.forEach(row => {
        const r = parseInt(row["Bar_Y"]);
        const c = parseInt(row["Chip No"]);
        const bin = parseInt(row["Bin"]);
        const protectCode = (row["Protect_Code"] || row["Edit_Code"] || "").toString().trim();

        if (!isNaN(r) && !isNaN(c)) {
          const key = `${r}-${c}`;
          matrixData[key] = bin;
          validPositions.add(key);

          if (protectCode === "LOCKED") {
            protectedPositions.add(key);
          }

          if (r > maxRow) maxRow = r;
          if (c > maxCol) maxCol = c;
        }
      });

      renderMatrix();
      saveToLocalStorage();
      showStatusMessage("æ–‡ä»¶åŠ è½½æˆåŠŸ", "success");
    }

    function renderMatrix() {
      const container = document.getElementById('matrix');
      const totalCells = (maxRow + 1) * (maxCol + 1);
      
      // å¦‚æœå•å…ƒæ ¼æ•°é‡è¿‡å¤šï¼Œæ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨å¹¶åˆ†æ‰¹æ¸²æŸ“
      if (totalCells > 2000) {
        showRenderingIndicator();
        
        // æ¸…é™¤ç°æœ‰å†…å®¹
        container.innerHTML = '';
        container.style.gridTemplateColumns = `repeat(${maxCol + 1}, ${cellSize}px)`;
        
        // åˆ†æ‰¹æ¸²æŸ“
        renderMatrixInBatches(container, 0);
      } else {
        // å°çŸ©é˜µç›´æ¥æ¸²æŸ“
        renderMatrixDirectly(container);
      }
      
      updateSelectedCells();
      updateCellStyles();
      updateSummary();
    }

    function renderMatrixDirectly(container) {
      container.innerHTML = '';
      container.style.gridTemplateColumns = `repeat(${maxCol + 1}, ${cellSize}px)`;
      
      for (let r = 0; r <= maxRow; r++) {
        for (let c = 0; c <= maxCol; c++) {
          createCell(container, r, c);
        }
      }
    }

    function renderMatrixInBatches(container, startIndex) {
      const totalCells = (maxRow + 1) * (maxCol + 1);
      let rendered = 0;
      
      for (let i = startIndex; i < totalCells && rendered < renderBatchSize; i++) {
        const r = Math.floor(i / (maxCol + 1));
        const c = i % (maxCol + 1);
        createCell(container, r, c);
        rendered++;
      }
      
      if (startIndex + rendered < totalCells) {
        // ç»§ç»­ä¸‹ä¸€æ‰¹
        setTimeout(() => {
          renderMatrixInBatches(container, startIndex + rendered);
        }, 0);
      } else {
        // æ¸²æŸ“å®Œæˆ
        hideRenderingIndicator();
        updateCellStyles();
      }
    }

    function createCell(container, r, c) {
      const key = `${r}-${c}`;
      const bin = matrixData[key] || 0;
      const cell = document.createElement('div');
      cell.className = 'cell';
      
      // æ ¹æ®è‡ªå®šä¹‰å€¼è®¾ç½®ç±»å
      if (bin === customBin1) {
        cell.classList.add('bin-1');
      } else if (bin === customBin2) {
        cell.classList.add('bin-2');
      } else if (bin !== 0) {
        cell.classList.add('bin-other');
      }
      
      cell.dataset.key = key;
      cell.dataset.row = r;
      cell.dataset.col = c;
      cell.dataset.bin = bin;

      if (protectedPositions.has(key)) {
        cell.classList.add('protected');
      }

      if (validPositions.has(key)) {
        cell.innerHTML = `
          <div style="font-size:10px; line-height:1; opacity:0.8;">${r}-${c}</div>
          <div style="font-size:14px; font-weight:bold;">${bin || ''}</div>
        `;
      } else {
        cell.innerText = '';
      }

      container.appendChild(cell);

      cell.addEventListener('mousedown', e => {
        if (e.button === 0 && !isLocked) {
          // å¦‚æœæ˜¯å—ä¿æŠ¤çš„æ ¼å­ï¼Œä¸å…è®¸å¼€å§‹é€‰æ‹©
          if (protectedPositions.has(key)) {
            return;
          }
          
          isSelecting = true;
          startCell = { row: r, col: c };
          isAddingSelection = e.ctrlKey || e.metaKey;
          if (!isAddingSelection) {
            selectedCells.clear();
          }
          
          // æ·»åŠ å½“å‰å•å…ƒæ ¼åˆ°é€‰æ‹©
          if (validPositions.has(key) && !protectedPositions.has(key)) {
            selectedCells.add(key);
          }
          
          // æ˜¾ç¤ºé€‰æ‹©æ¡† - ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å•å…ƒæ ¼åæ ‡è®¡ç®—
          const left = c * cellSize;
          const top = r * cellSize;
          
          selectionBox.style.left = left + 'px';
          selectionBox.style.top = top + 'px';
          selectionBox.style.width = cellSize + 'px';
          selectionBox.style.height = cellSize + 'px';
          selectionBox.style.display = 'block';
          
          updateCellStyles();
        }
      });

      cell.addEventListener('contextmenu', e => {
        if (protectedPositions.has(key)) return;
        e.preventDefault();
        showContextMenu(e);
      });
    }

    function showRenderingIndicator() {
      const indicator = document.getElementById('rendering-indicator');
      if (indicator) {
        indicator.style.display = 'block';
      }
    }

    function hideRenderingIndicator() {
      const indicator = document.getElementById('rendering-indicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }

    function updateSelectedCells() {
      const newSelectedCells = new Set();
      selectedCells.forEach(key => {
        if (validPositions.has(key)) {
          newSelectedCells.add(key);
        }
      });
      selectedCells = newSelectedCells;
    }

    function handleMouseMove(e) {
      if (!isSelecting || !startCell) return;
      
      const matrixContainer = document.getElementById('matrix-container');
      const matrix = document.getElementById('matrix');
      
      // è·å–é¼ æ ‡åœ¨çŸ©é˜µå®¹å™¨å†…çš„ç›¸å¯¹ä½ç½® - ä¿®å¤ï¼šè€ƒè™‘æ»šåŠ¨å’Œè¾¹æ¡†
      const containerRect = matrixContainer.getBoundingClientRect();
      const scrollLeft = matrixContainer.scrollLeft;
      const scrollTop = matrixContainer.scrollTop;
      const borderWidth = 1; // è¾¹æ¡†å®½åº¦
      const padding = 10; // å†…è¾¹è·
      
      const mouseX = e.clientX - containerRect.left + scrollLeft - borderWidth - padding;
      const mouseY = e.clientY - containerRect.top + scrollTop - borderWidth - padding;
      
      // è®¡ç®—å½“å‰é¼ æ ‡æ‰€åœ¨çš„å•å…ƒæ ¼
      const cellX = Math.floor(mouseX / (cellSize + 2)); // 2pxæ˜¯å•å…ƒæ ¼é—´è·
      const cellY = Math.floor(mouseY / (cellSize + 2));
      
      // ç¡®ä¿åœ¨çŸ©é˜µèŒƒå›´å†…
      if (cellX < 0 || cellX > maxCol || cellY < 0 || cellY > maxRow) {
        return;
      }
      
      // æ›´æ–°é€‰æ‹©æ¡†
      updateSelectionBox(startCell, { row: cellY, col: cellX });
      
      // æ›´æ–°é€‰æ‹©
      updateSelection(startCell, { row: cellY, col: cellX });
    }

    function updateSelectionBox(start, end) {
      if (!selectionBox) return;
      
      const startRow = Math.min(start.row, end.row);
      const endRow = Math.max(start.row, end.row);
      const startCol = Math.min(start.col, end.col);
      const endCol = Math.max(start.col, end.col);
      
      // ä¿®å¤ï¼šè€ƒè™‘å•å…ƒæ ¼é—´è·
      const gap = 2; // å•å…ƒæ ¼é—´è·
      const left = startCol * (cellSize + gap);
      const top = startRow * (cellSize + gap);
      const width = (endCol - startCol + 1) * (cellSize + gap) - gap;
      const height = (endRow - startRow + 1) * (cellSize + gap) - gap;
      
      selectionBox.style.left = left + 'px';
      selectionBox.style.top = top + 'px';
      selectionBox.style.width = width + 'px';
      selectionBox.style.height = height + 'px';
      selectionBox.style.display = 'block';
    }

    function updateSelection(start, end) {
      const minRow = Math.min(start.row, end.row);
      const maxRow = Math.max(start.row, end.row);
      const minCol = Math.min(start.col, end.col);
      const maxCol = Math.max(start.col, end.col);

      if (!isAddingSelection) selectedCells.clear();

      // éå†é€‰æ‹©åŒºåŸŸï¼Œè·³è¿‡å—ä¿æŠ¤çš„æ ¼å­
      for (let r = minRow; r <= maxRow; r++) {
        for (let c = minCol; c <= maxCol; c++) {
          const key = `${r}-${c}`;
          if (validPositions.has(key) && !protectedPositions.has(key)) {
            selectedCells.add(key);
          }
        }
      }
      updateCellStyles();
    }

    function handleMouseUp(e) {
      if (isSelecting) {
        isSelecting = false;
        startCell = null;
        
        // éšè—é€‰æ‹©æ¡†
        if (selectionBox) {
          selectionBox.style.display = 'none';
        }
      }
    }

    function updateCellStyles() {
      // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹æ›´æ–°
      if (renderTimeout) {
        clearTimeout(renderTimeout);
      }
      
      renderTimeout = setTimeout(() => {
        document.querySelectorAll('.cell').forEach(cell => {
          const key = cell.dataset.key;
          const bin = parseInt(cell.dataset.bin) || 0;
          
          // é‡ç½®ç±»
          cell.className = 'cell';
          
          // æ ¹æ®è‡ªå®šä¹‰å€¼æ·»åŠ ç±»
          if (bin === customBin1) {
            cell.classList.add('bin-1');
          } else if (bin === customBin2) {
            cell.classList.add('bin-2');
          } else if (bin !== 0) {
            cell.classList.add('bin-other');
          }
          
          if (selectedCells.has(key)) cell.classList.add('selected');
          if (protectedPositions.has(key)) cell.classList.add('protected');
        });
      }, 50);
    }

    function updateCellSize(delta) {
      cellSize = Math.max(10, Math.min(80, cellSize + delta));
      document.documentElement.style.setProperty('--cell-size', cellSize + 'px');
      document.getElementById('matrix').style.gridTemplateColumns = `repeat(${maxCol + 1}, ${cellSize}px)`;
      renderMatrix();
      showStatusMessage(`å•å…ƒæ ¼å°ºå¯¸: ${cellSize}px`, "info");
    }

    function searchCell() {
      const input = prompt("è¯·è¾“å…¥åæ ‡ï¼ˆæ ¼å¼ï¼šè¡Œ-åˆ—ï¼Œä¾‹å¦‚ 0-3ï¼‰ï¼š");
      if (!input) return;
      if (!/^\d+-\d+$/.test(input)) {
        alert("æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥å½¢å¦‚ '0-3' çš„åæ ‡ã€‚");
        return;
      }
      if (matrixData[input] !== undefined) {
        selectedCells.clear();
        selectedCells.add(input);
        updateCellStyles();
        const cell = document.querySelector(`.cell[data-key='${input}']`);
        if (cell) cell.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
        showStatusMessage(`å®šä½åˆ°åæ ‡: ${input}`, "success");
      } else {
        alert("æœªæ‰¾åˆ°å¯¹åº”åæ ‡ã€‚");
      }
    }

    function exportToExcel() {
      const headers = [
        "CUSTOMER PRODUCT ID ", "COL QTY BAR", "ROW QTY BAR", "DIE ON BAR STD",
        "BAR No", "Lot ID", "Wafer ID ", "Carrier ID", "Bar_X",
        "Bar_Y", "Chip No", "Die ID", "Bin"
      ];

      const fixedFields = [
        "OC3610-TX1 V200-Chip-CH4", 4, 24, 23,
        0, "A120J62#01-2", "A120J62#01-2", "A120J62#01-2CC02", 0
      ];

      const dieIdList = Array.from({ length: 1311 }, (_, i) => "FD" + String(i + 1).padStart(2, '0'));
      const data = [headers];
      let dieIndex = 0;

      for (let r = 0; r <= maxRow; r++) {
        for (let c = 0; c <= maxCol; c++) {
          const key = `${r}-${c}`;
          if (!validPositions.has(key)) continue;
          const bin = matrixData[key];
          const dieId = dieIdList[dieIndex++] || '';
          const row = [...fixedFields, r, c, dieId, bin];
          data.push(row);
        }
      }

      const worksheet = XLSX.utils.aoa_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Mapping");
      XLSX.writeFile(workbook, `mapping_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`);
      showStatusMessage("å¯¼å‡ºæˆåŠŸ", "success");
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('mappingConfig');
      if (saved) {
        try {
          const config = JSON.parse(saved);
          matrixData = config.matrixData || {};
          maxRow = config.maxRow || 9;
          maxCol = config.maxCol || 9;
          validPositions = new Set(config.validPositions || []);
          protectedPositions = new Set(config.protectedPositions || []);
          
          // åŠ è½½è‡ªå®šä¹‰è®¾ç½®
          if (config.customBin1) customBin1 = config.customBin1;
          if (config.customBin2) customBin2 = config.customBin2;
          if (config.customOtherBin) customOtherBin = config.customOtherBin;
          
          renderMatrix();
          updateBinDisplays();
          return true;
        } catch {
          console.warn("æœ¬åœ°å­˜å‚¨æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¿½ç•¥");
        }
      }
      return false;
    }

    function saveToLocalStorage() {
      const config = {
        matrixData,
        maxRow,
        maxCol,
        validPositions: Array.from(validPositions),
        protectedPositions: Array.from(protectedPositions),
        customBin1,
        customBin2,
        customOtherBin,
        cellSize
      };
      localStorage.setItem('mappingConfig', JSON.stringify(config));
    }

    function downloadTemplate() {
      const a = document.createElement('a');
      a.href = "TIA.xlsx";
      a.download = "TIA_Mapping_Template.xlsx";
      a.click();
      showStatusMessage("æ¨¡æ¿ä¸‹è½½å¼€å§‹", "info");
    }

    function toggleLock() {
      isLocked = !isLocked;
      const lockButton = document.querySelector('#lock-toggle');
      if (isLocked) {
        lockButton.innerHTML = '<span>ğŸ”’</span> å·²é”å®š';
        lockButton.style.background = '#f44336';
        showStatusMessage("å·²é”å®šç¼–è¾‘", "warning");
      } else {
        lockButton.innerHTML = '<span>ğŸ”“</span> å¯ç¼–è¾‘æ¨¡å¼';
        lockButton.style.background = '#9c27b0';
        showStatusMessage("å·²è§£é”ç¼–è¾‘", "success");
      }
    }

    function setBin(binValue) {
      if (isLocked) {
        showStatusMessage("å·²é”å®šï¼Œæ— æ³•ä¿®æ”¹", "error");
        return;
      }
      
      if (selectedCells.size === 0) {
        showStatusMessage("è¯·å…ˆé€‰æ‹©è¦è®¾ç½®çš„å•å…ƒæ ¼", "warning");
        return;
      }
      
      // æ˜ å°„è‡ªå®šä¹‰å€¼
      let actualBinValue;
      if (binValue === 1) {
        actualBinValue = customBin1;
      } else if (binValue === 2) {
        actualBinValue = customBin2;
      } else {
        actualBinValue = binValue;
      }
      
      selectedCells.forEach(key => {
        matrixData[key] = actualBinValue;
      });
      renderMatrix();
      saveToLocalStorage();
      updateSummary();
      showStatusMessage(`å·²è®¾ç½® ${selectedCells.size} ä¸ªå•å…ƒæ ¼ä¸º ${actualBinValue}`, "success");
    }

    function updateSummary() {
      let bin1 = 0;
      let bin2 = 0;
      let total = 0;
      validPositions.forEach(key => {
        const bin = matrixData[key];
        if (bin === customBin1) bin1++;
        else if (bin === customBin2) bin2++;
        if (bin !== undefined) total++;
      });
      document.getElementById('summary').innerHTML = 
        `æœ‰æ–™ (<span id="bin1-value">${customBin1}</span>)ï¼š${bin1}ï¼Œ ` +
        `æ— æ–™ (<span id="bin2-value">${customBin2}</span>)ï¼š${bin2}ï¼Œ ` +
        `æ€»æ•°ï¼š${total}`;
    }

    function handleContextMenu(e) {
      e.preventDefault();
      showContextMenu(e);
    }

    function showContextMenu(e) {
      if (selectedCells.size > 0) {
        let allProtected = true;
        selectedCells.forEach(key => {
          if (!protectedPositions.has(key)) allProtected = false;
        });
        if (allProtected) return;
      }
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      const menuWidth = menu.offsetWidth;
      const menuHeight = menu.offsetHeight;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      let left = e.pageX;
      let top = e.pageY;
      if (left + menuWidth > windowWidth) left = windowWidth - menuWidth - 10;
      if (top + menuHeight > windowHeight) top = windowHeight - menuHeight - 10;
      menu.style.left = left + 'px';
      menu.style.top = top + 'px';
    }

    function hideContextMenu() {
      document.getElementById('context-menu').style.display = 'none';
    }

    function clearAllSelections() {
      selectedCells.clear();
      updateCellStyles();
      hideContextMenu();
      showStatusMessage("å·²æ¸…ç©ºé€‰æ‹©", "info");
    }

    function setBinFromMenu(binValue) {
      if (isLocked) {
        showStatusMessage("å·²é”å®šï¼Œæ— æ³•ä¿®æ”¹", "error");
        hideContextMenu();
        return;
      }
      if (selectedCells.size === 0) {
        alert("è¯·å…ˆé€‰æ‹©è¦è®¾ç½®çš„å•å…ƒæ ¼");
        hideContextMenu();
        return;
      }
      setBin(binValue);
      hideContextMenu();
    }

    function loadSourceFile() {
      if (isLocked) {
        showStatusMessage("å·²é”å®šï¼Œè¯·å…ˆè§£é”ç¼–è¾‘", "error");
        hideContextMenu();
        return;
      }

      showStatusMessage("æ­£åœ¨è‡ªåŠ¨åŠ è½½æºæ–‡ä»¶...", "info");

      fetch(SOURCE_FILE_URL)
        .then(response => {
          if (!response.ok) throw new Error(`ç½‘ç»œå“åº”ä¸æ­£å¸¸: ${response.status}`);
          return response.arrayBuffer();
        })
        .then(data => {
          processFileData(data);
          showStatusMessage("æºæ–‡ä»¶è‡ªåŠ¨åŠ è½½æˆåŠŸï¼", "success");
        })
        .catch(error => {
          console.error('åŠ è½½æºæ–‡ä»¶å¤±è´¥:', error);
          showStatusMessage(`åŠ è½½å¤±è´¥: ${error.message}`, "error");

          setTimeout(() => {
            if (confirm('è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œæ˜¯å¦æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶ï¼Ÿ')) {
              document.getElementById('upload').click();
            }
          }, 3000);
        })
        .finally(() => {
          hideContextMenu();
        });
    }

    function showStatusMessage(message, type = 'info') {
      const existingMessage = document.getElementById('status-message');
      if (existingMessage) {
        existingMessage.remove();
      }

      const messageElement = document.createElement('div');
      messageElement.id = 'status-message';
      messageElement.className = `status-message status-${type}`;
      messageElement.textContent = message;

      document.body.appendChild(messageElement);

      setTimeout(() => {
        messageElement.style.opacity = '0';
        setTimeout(() => messageElement.remove(), 300);
      }, 3000);
    }
    
    // å…¬å‘ŠåŠŸèƒ½
    function showAnnouncement() {
      const content = document.getElementById('announcement-content');
      content.classList.add('show');
    }
    
    function hideAnnouncement() {
      const content = document.getElementById('announcement-content');
      content.classList.remove('show');
    }
    
    function toggleAnnouncement() {
      const content = document.getElementById('announcement-content');
      content.classList.toggle('show');
    }
    
    function closeAnnouncement() {
      hideAnnouncement();
      announcementShown = true;
      localStorage.setItem('announcementShown', 'true');
    }
    
    // è®¾ç½®åŠŸèƒ½
    function showSettingsModal() {
      document.getElementById('bin1-input').value = customBin1;
      document.getElementById('bin2-input').value = customBin2;
      document.getElementById('other-bin-input').value = customOtherBin;
      document.getElementById('settings-modal').style.display = 'flex';
    }
    
    function hideSettingsModal() {
      document.getElementById('settings-modal').style.display = 'none';
    }
    
    function saveSettings() {
      const newBin1 = parseInt(document.getElementById('bin1-input').value) || 1;
      const newBin2 = parseInt(document.getElementById('bin2-input').value) || 2;
      const newOtherBin = parseInt(document.getElementById('other-bin-input').value) || 0;
      
      if (newBin1 === newBin2 || newBin1 === newOtherBin || newBin2 === newOtherBin) {
        showStatusMessage("é”™è¯¯ï¼šæœ‰æ–™ã€æ— æ–™å’Œå…¶ä»–æ•°å€¼ä¸èƒ½ç›¸åŒ", "error");
        return;
      }
      
      customBin1 = newBin1;
      customBin2 = newBin2;
      customOtherBin = newOtherBin;
      
      updateBinDisplays();
      renderMatrix();
      saveToLocalStorage();
      hideSettingsModal();
      showStatusMessage("è®¾ç½®å·²ä¿å­˜å¹¶åº”ç”¨", "success");
    }
    
    function updateBinDisplays() {
      document.getElementById('bin1-value').textContent = customBin1;
      document.getElementById('bin2-value').textContent = customBin2;
      document.getElementById('bin1-display').textContent = customBin1;
      document.getElementById('bin2-display').textContent = customBin2;
      document.getElementById('context-bin1').textContent = customBin1;
      document.getElementById('context-bin2').textContent = customBin2;
    }
    
    // çŸ©é˜µå°ºå¯¸è®¾ç½®åŠŸèƒ½
    function showMatrixSettings() {
      document.getElementById('rows-input').value = maxRow + 1;
      document.getElementById('cols-input').value = maxCol + 1;
      document.getElementById('matrix-modal').style.display = 'flex';
    }
    
    function hideMatrixModal() {
      document.getElementById('matrix-modal').style.display = 'none';
    }
    
    function applyMatrixSize() {
      const newRows = parseInt(document.getElementById('rows-input').value) || 10;
      const newCols = parseInt(document.getElementById('cols-input').value) || 10;
      
      if (newRows < 1 || newRows > 100 || newCols < 1 || newCols > 100) {
        showStatusMessage("é”™è¯¯ï¼šè¡Œæ•°å’Œåˆ—æ•°å¿…é¡»åœ¨1-100ä¹‹é—´", "error");
        return;
      }
      
      // å¦‚æœè®¾ç½®è¿‡å¤§å°ºå¯¸ï¼Œç»™å‡ºè­¦å‘Š
      if (newRows * newCols > 5000) {
        if (!confirm(`è­¦å‘Šï¼šè®¾ç½®${newRows}Ã—${newCols}=${newRows*newCols}ä¸ªå•å…ƒæ ¼å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚\n\nå»ºè®®ï¼š\n1. ä½¿ç”¨è¾ƒå°çš„å•å…ƒæ ¼å°ºå¯¸\n2. æˆ–è€…åˆ†æ‰¹å¤„ç†æ•°æ®\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
          return;
        }
      }
      
      const oldMaxRow = maxRow;
      const oldMaxCol = maxCol;
      
      maxRow = newRows - 1;
      maxCol = newCols - 1;
      
      // æ›´æ–°æœ‰æ•ˆä½ç½®
      const newValidPositions = new Set();
      for (let r = 0; r <= maxRow; r++) {
        for (let c = 0; c <= maxCol; c++) {
          const key = `${r}-${c}`;
          if (validPositions.has(key)) {
            newValidPositions.add(key);
          } else {
            // å¦‚æœæ˜¯æ–°å¢çš„ä½ç½®ï¼Œæ·»åŠ åˆ°æ•°æ®ä¸­
            newValidPositions.add(key);
            if (!matrixData[key]) {
              matrixData[key] = 0;
            }
          }
        }
      }
      
      validPositions = newValidPositions;
      
      // æ¸…ç†è¶…å‡ºèŒƒå›´çš„æ•°æ®
      Object.keys(matrixData).forEach(key => {
        const [r, c] = key.split('-').map(Number);
        if (r > maxRow || c > maxCol) {
          delete matrixData[key];
        }
      });
      
      renderMatrix();
      saveToLocalStorage();
      hideMatrixModal();
      showStatusMessage(`çŸ©é˜µå°ºå¯¸å·²æ›´æ”¹ä¸º ${newRows}Ã—${newCols}`, "success");
    }
  </script>
</body>
</html>