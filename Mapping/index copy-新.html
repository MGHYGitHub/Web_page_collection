<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>è“è†œ Mapping å·¥å…·</title>
  <script src="./xlsx.full.min.js"></script>
  <!-- ä½¿ç”¨CDNé“¾æ¥ -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script> -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background: linear-gradient(135deg, #c3d1ff, #f5f7fa);
      overflow-x: hidden;
    }

    .glass-container {
      backdrop-filter: blur(15px);
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 1200px;
      color: #333;
      margin: 0 auto;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #222;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    #controls button,
    #controls input[type="file"] {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      background: #5c6bc0;
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #controls button:hover {
      background: #3f51b5;
    }

    #matrix-container {
      position: relative;
      overflow: auto;
      max-height: 70vh;
      padding: 5px;
      margin: 0 auto;
      display: flex;
      justify-content: center;
    }

    #matrix {
      display: grid;
      gap: 2px;
      user-select: none;
    }

    .cell {
      text-align: center;
      line-height: 30px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.5);
      transition: background 0.2s;
      width: var(--cell-size);
      height: var(--cell-size);
      line-height: var(--cell-size);
      position: relative;
    }

    :root {
      --cell-size: 30px;
    }

    .bin-1 {
      background-color: #4caf50;
      color: white;
    }

    .bin-2 {
      background-color: #f44336;
      color: white;
    }

    .selected {
      outline: 2px solid #2196f3;
    }

    #context-menu {
      position: fixed;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      padding: 10px 0;
      display: none;
      z-index: 1000;
      min-width: 160px;
    }

    .menu-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.2s;
    }

    .menu-item:hover {
      background-color: #e0e0e0;
    }

    .menu-divider {
      height: 1px;
      background-color: #ccc;
      margin: 5px 0;
    }

    .protected {
      opacity: 0.7;
      cursor: not-allowed !important;
      position: relative;
      background-color: #f0f0f0 !important;
    }

    .protected::after {
      content: "ğŸ”’";
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 10px;
    }

    .protected.bin-1 {
      background-color: #c8e6c9 !important;
      color: #666;
    }

    .protected.bin-2 {
      background-color: #ffcdd2 !important;
      color: #666;
    }

    .protected.selected {
      outline: none !important;
    }

    .status-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 2000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      max-width: 80%;
      text-align: center;
    }

    .status-success {
      background-color: #4caf50;
    }

    .status-error {
      background-color: #f44336;
    }

    .status-info {
      background-color: #2196f3;
    }

    .status-warning {
      background-color: #ff9800;
    }

    /* æ·»åŠ å…¬å‘Šæ ·å¼ */
    .announcement {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin: 20px auto;
      max-width: 800px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .announcement h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .announcement p {
      margin: 5px 0;
      font-size: 14px;
      line-height: 1.5;
    }

    .announcement .author {
      font-weight: bold;
      color: #ffeb3b;
      margin-top: 10px;
    }

    .announcement .version {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 5px;
    }

    .announcement .warning {
      color: #ff6b6b;
      font-weight: bold;
      margin-top: 8px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="glass-container">
    <h2>è“è†œçŸ©é˜µ Mapping å·¥å…·</h2>
    <!-- æ·»åŠ å…¬å‘ŠåŒºåŸŸ -->
    <div class="announcement">
      <h3>ğŸ“¢ ç³»ç»Ÿå…¬å‘Š</h3>
      <p>æ¬¢è¿ä½¿ç”¨è“è†œçŸ©é˜µMappingä¸“ä¸šå·¥å…· [TIAè“è†œ]</p>
      <p>æœ¬å·¥å…·æ”¯æŒExcelæ•°æ®å¯¼å…¥å¯¼å‡ºã€æ™ºèƒ½æ¡†é€‰ã€çŠ¶æ€ç®¡ç†ã€CtrlæŒ‰ä½å¤šé€‰åŒºåŸŸã€å³é”®èœå•ä¸€é”®è®¾ç½®ç­‰åŠŸèƒ½</p>
      <div class="warning">âš ï¸ æ³¨æ„ï¼šè¯·å‹¿éšæ„ä¿®æ”¹å—ä¿æŠ¤çš„å•å…ƒæ ¼</div>
      <div class="author">ğŸ‘¨â€ğŸ’» å¼€å‘è€…ï¼šå»–å­å®¸</div>
      <div class="version">ğŸ” ç‰ˆæœ¬ï¼šv2.1.0 | é˜²ä¼ªæ ‡è¯†ï¼šTIA-MAP-2024</div>
    </div>
    <div id="summary" style="text-align:center; margin-bottom: 15px; font-size:16px; font-weight: bold;">
      æœ‰æ–™ï¼š0ï¼Œ æ— æ–™ï¼š0ï¼Œæ€»æ•°ï¼š0
    </div>
    <div id="controls">
      <input type="file" id="upload" accept=".xlsx, .xls, .csv" />
      <button onclick="setBin(1)">è®¾ç½®ä¸ºæœ‰æ–™ï¼ˆ1ï¼‰</button>
      <button onclick="setBin(2)">è®¾ç½®ä¸ºæ— æ–™ï¼ˆ2ï¼‰</button>
      <button onclick="updateCellSize(5)">æ”¾å¤§</button>
      <button onclick="updateCellSize(-5)">ç¼©å°</button>
      <button onclick="searchCell()">æœç´¢å®šä½</button>
      <button onclick="downloadTemplate()">ä¸‹è½½Mappingæ¨¡æ¿Excelæ–‡ä»¶</button>
      <button onclick="exportToExcel()">å¯¼å‡ºä¸º Excel</button>
      <button id="lock-toggle" onclick="toggleLock()">ğŸ”“ å¯ç¼–è¾‘</button>
      <button onclick="loadSourceFile()" style="background:#9c27b0;">è‡ªåŠ¨è·å–æºæ–‡ä»¶</button>
    </div>
    <div id="matrix-container">
      <div id="matrix"></div>
    </div>
  </div>

  <!-- ç®€åŒ–å³é”®èœå• -->
  <div id="context-menu">
    <div class="menu-item" onclick="setBinFromMenu(1)">è®¾ç½®ä¸ºæœ‰æ–™ï¼ˆ1ï¼‰</div>
    <div class="menu-item" onclick="setBinFromMenu(2)">è®¾ç½®ä¸ºæ— æ–™ï¼ˆ2ï¼‰</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="loadSourceFile()">è‡ªåŠ¨è·å–æºæ–‡ä»¶</div>
    <div class="menu-item" onclick="document.getElementById('upload').click()">é€‰æ‹©æ–‡ä»¶...</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="clearAllSelections()">æ¸…ç©ºé€‰æ‹©çŠ¶æ€</div>
    <div class="menu-item" onclick="hideContextMenu()">å–æ¶ˆ</div>
  </div>

  <script>
    // é»˜è®¤æºæ–‡ä»¶è·¯å¾„
    const SOURCE_FILE_URL = './TIA.xlsx';

    // æ ¸å¿ƒæ•°æ®
    let matrixData = {};
    let validPositions = new Set();
    let selectedCells = new Set();
    let isSelecting = false;
    let startCell = null;
    let isAddingSelection = false;
    let maxRow = 0, maxCol = 0;
    let cellSize = 30;
    let isLocked = false;
    let protectedPositions = new Set();

    // äº‹ä»¶ç›‘å¬
    document.getElementById('upload').addEventListener('change', handleFile);
    document.addEventListener('mouseup', handleMouseUp);
    document.addEventListener('contextmenu', handleContextMenu);
    document.addEventListener('click', hideContextMenu);
    document.addEventListener('mousemove', handleMouseMove);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        processFileData(evt.target.result);
      };
      reader.readAsArrayBuffer(file);
    }

    function processFileData(arrayBuffer) {
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

      matrixData = {};
      validPositions.clear();
      protectedPositions.clear();
      maxRow = 0;
      maxCol = 0;

      json.forEach(row => {
        const r = parseInt(row["Bar_Y"]);
        const c = parseInt(row["Chip No"]);
        const bin = parseInt(row["Bin"]);
        const protectCode = (row["Protect_Code"] || row["Edit_Code"] || "").toString().trim();

        if (!isNaN(r) && !isNaN(c)) {
          const key = `${r}-${c}`;
          matrixData[key] = bin;
          validPositions.add(key);

          if (protectCode === "LOCKED") {
            protectedPositions.add(key);
          }

          if (r > maxRow) maxRow = r;
          if (c > maxCol) maxCol = c;
        }
      });

      renderMatrix();
      saveToLocalStorage();
    }

    function renderMatrix() {
      const container = document.getElementById('matrix');
      container.innerHTML = '';
      container.style.gridTemplateColumns = `repeat(${maxCol + 1}, ${cellSize}px)`;

      const newSelectedCells = new Set();
      selectedCells.forEach(key => {
        if (validPositions.has(key)) {
          newSelectedCells.add(key);
        }
      });
      selectedCells = newSelectedCells;

      for (let r = 0; r <= maxRow; r++) {
        for (let c = 0; c <= maxCol; c++) {
          const key = `${r}-${c}`;
          const bin = matrixData[key] || 0;
          const cell = document.createElement('div');
          cell.className = `cell bin-${bin}`;
          cell.dataset.key = key;
          cell.dataset.row = r;
          cell.dataset.col = c;

          if (protectedPositions.has(key)) {
            cell.classList.add('protected');
          }

          if (validPositions.has(key)) {
            cell.classList.add(`bin-${bin}`);
            cell.innerHTML = `
              <div style="font-size:10px; line-height:1;">${r}-${c}</div>
              <div style="font-size:14px; font-weight:bold;">${bin || ''}</div>
            `;
          } else {
            cell.innerText = '';
          }

          container.appendChild(cell);

          cell.addEventListener('mousedown', e => {
            if (protectedPositions.has(key)) return;
            if (e.button === 0 && !isLocked) {
              isSelecting = true;
              startCell = { row: r, col: c };
              isAddingSelection = e.ctrlKey || e.metaKey;
              if (!isAddingSelection) selectedCells.clear();
              selectedCells.add(key);
              updateCellStyles();
            }
          });

          cell.addEventListener('mouseenter', e => {
            if (protectedPositions.has(key)) return;
            if (isSelecting && startCell) {
              const currentCell = { row: r, col: c };
              updateSelection(startCell, currentCell);
            }
          });

          cell.addEventListener('contextmenu', e => {
            if (protectedPositions.has(key)) return;
            e.preventDefault();
            showContextMenu(e);
          });
        }
      }

      updateCellStyles();
      updateSummary();
    }

    function updateSelection(start, end) {
      const minRow = Math.min(start.row, end.row);
      const maxRow = Math.max(start.row, end.row);
      const minCol = Math.min(start.col, end.col);
      const maxCol = Math.max(start.col, end.col);

      if (!isAddingSelection) selectedCells.clear();

      for (let r = minRow; r <= maxRow; r++) {
        for (let c = minCol; c <= maxCol; c++) {
          const key = `${r}-${c}`;
          if (validPositions.has(key) && !protectedPositions.has(key)) {
            selectedCells.add(key);
          }
        }
      }
      updateCellStyles();
    }

    function handleMouseUp(e) {
      if (isSelecting) {
        isSelecting = false;
        startCell = null;
      }
    }

    function handleMouseMove(e) {
      if (!isSelecting || !startCell) return;
      const matrix = document.getElementById('matrix');
      const cells = matrix.getElementsByClassName('cell');
      let currentCell = null;

      for (let cell of cells) {
        const rect = cell.getBoundingClientRect();
        if (e.clientX >= rect.left && e.clientX <= rect.right &&
          e.clientY >= rect.top && e.clientY <= rect.bottom) {
          currentCell = cell;
          break;
        }
      }

      if (currentCell && !protectedPositions.has(currentCell.dataset.key)) {
        const row = parseInt(currentCell.dataset.row);
        const col = parseInt(currentCell.dataset.col);
        const currentCellPos = { row: row, col: col };
        updateSelection(startCell, currentCellPos);
      }
    }

    function updateCellStyles() {
      document.querySelectorAll('.cell').forEach(cell => {
        const key = cell.dataset.key;
        const bin = matrixData[key] || 0;
        cell.className = `cell bin-${bin}`;
        if (selectedCells.has(key)) cell.classList.add('selected');
        if (!validPositions.has(key)) return;
      });
    }

    function updateCellSize(delta) {
      cellSize = Math.max(10, cellSize + delta);
      document.documentElement.style.setProperty('--cell-size', cellSize + 'px');
      document.getElementById('matrix').style.gridTemplateColumns = `repeat(${maxCol + 1}, ${cellSize}px)`;
      renderMatrix();
    }

    function searchCell() {
      const input = prompt("è¯·è¾“å…¥åæ ‡ï¼ˆæ ¼å¼ï¼šè¡Œ-åˆ—ï¼Œä¾‹å¦‚ 0-3ï¼‰ï¼š");
      if (!input) return;
      if (!/^\d+-\d+$/.test(input)) {
        alert("æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥å½¢å¦‚ '0-3' çš„åæ ‡ã€‚");
        return;
      }
      if (matrixData[input] !== undefined) {
        selectedCells.clear();
        selectedCells.add(input);
        updateCellStyles();
        const cell = document.querySelector(`.cell[data-key='${input}']`);
        if (cell) cell.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
      } else {
        alert("æœªæ‰¾åˆ°å¯¹åº”åæ ‡ã€‚");
      }
    }

    function exportToExcel() {
      const headers = [
        "CUSTOMER PRODUCT ID ", "COL QTY BAR", "ROW QTY BAR", "DIE ON BAR STD",
        "BAR No", "Lot ID", "Wafer ID ", "Carrier ID", "Bar_X",
        "Bar_Y", "Chip No", "Die ID", "Bin"
      ];

      const fixedFields = [
        "OC3610-TX1 V200-Chip-CH4", 4, 24, 23,
        0, "A120J62#01-2", "A120J62#01-2", "A120J62#01-2CC02", 0
      ];

      const dieIdList = Array.from({ length: 1311 }, (_, i) => "FD" + String(i + 1).padStart(2, '0'));
      const data = [headers];
      let dieIndex = 0;

      for (let r = 0; r <= maxRow; r++) {
        for (let c = 0; c <= maxCol; c++) {
          const key = `${r}-${c}`;
          if (!validPositions.has(key)) continue;
          const bin = matrixData[key];
          const dieId = dieIdList[dieIndex++] || '';
          const row = [...fixedFields, r, c, dieId, bin];
          data.push(row);
        }
      }

      const worksheet = XLSX.utils.aoa_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Mapping");
      XLSX.writeFile(workbook, `mapping_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`);
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('mappingConfig');
      if (saved) {
        try {
          const config = JSON.parse(saved);
          matrixData = config.matrixData || {};
          maxRow = config.maxRow || 0;
          maxCol = config.maxCol || 0;
          validPositions = new Set(config.validPositions || []);
          protectedPositions = new Set(config.protectedPositions || []);
          renderMatrix();
          return true;
        } catch {
          console.warn("æœ¬åœ°å­˜å‚¨æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¿½ç•¥");
        }
      }
      return false;
    }

    function saveToLocalStorage() {
      const config = {
        matrixData,
        maxRow,
        maxCol,
        validPositions: Array.from(validPositions),
        protectedPositions: Array.from(protectedPositions),
      };
      localStorage.setItem('mappingConfig', JSON.stringify(config));
    }

    window.onload = () => {
      if (!loadFromLocalStorage()) {
        maxRow = 9;
        maxCol = 9;
        for (let r = 0; r <= maxRow; r++) {
          for (let c = 0; c <= maxCol; c++) {
            validPositions.add(`${r}-${c}`);
          }
        }
        renderMatrix();
        saveToLocalStorage();
      }
    };

    function downloadTemplate() {
      const a = document.createElement('a');
      a.href = "xxxxx";
      a.download = "TIA.xlsx";
      a.click();
    }

    function toggleLock() {
      isLocked = !isLocked;
      const lockButton = document.querySelector('#lock-toggle');
      if (isLocked) {
        lockButton.textContent = 'ğŸ”’ å·²é”å®š';
        alert("å·²é”å®šç¼–è¾‘");
      } else {
        lockButton.textContent = 'ğŸ”“ å¯ç¼–è¾‘';
        alert("å·²è§£é”ç¼–è¾‘");
      }
    }

    function setBin(binValue) {
      if (isLocked) {
        alert("å·²é”å®šï¼Œæ— æ³•ä¿®æ”¹ã€‚");
        return;
      }
      selectedCells.forEach(key => {
        matrixData[key] = binValue;
      });
      renderMatrix();
      saveToLocalStorage();
      updateSummary();
    }

    function updateSummary() {
      let bin1 = 0;
      let bin2 = 0;
      let total = 0;
      validPositions.forEach(key => {
        const bin = matrixData[key];
        if (bin === 1) bin1++;
        else if (bin === 2) bin2++;
        total++;
      });
      document.getElementById('summary').textContent = `æœ‰æ–™ï¼š${bin1}ï¼Œ æ— æ–™ï¼š${bin2}ï¼Œ æ€»æ•°ï¼š${total}`;
    }

    function handleContextMenu(e) {
      e.preventDefault();
      showContextMenu(e);
    }

    function showContextMenu(e) {
      if (selectedCells.size > 0) {
        let allProtected = true;
        selectedCells.forEach(key => {
          if (!protectedPositions.has(key)) allProtected = false;
        });
        if (allProtected) return;
      }
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      const menuWidth = menu.offsetWidth;
      const menuHeight = menu.offsetHeight;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      let left = e.pageX;
      let top = e.pageY;
      if (left + menuWidth > windowWidth) left = windowWidth - menuWidth - 10;
      if (top + menuHeight > windowHeight) top = windowHeight - menuHeight - 10;
      menu.style.left = left + 'px';
      menu.style.top = top + 'px';
    }

    function hideContextMenu() {
      document.getElementById('context-menu').style.display = 'none';
    }

    function clearAllSelections() {
      selectedCells.clear();
      updateCellStyles();
      hideContextMenu();
    }

    function setBinFromMenu(binValue) {
      if (isLocked) {
        alert("å·²é”å®šï¼Œæ— æ³•ä¿®æ”¹ã€‚");
        hideContextMenu();
        return;
      }
      if (selectedCells.size === 0) {
        alert("è¯·å…ˆé€‰æ‹©è¦è®¾ç½®çš„å•å…ƒæ ¼");
        hideContextMenu();
        return;
      }
      setBin(binValue);
      hideContextMenu();
    }

    function loadSourceFile() {
      if (isLocked) {
        showStatusMessage("å·²é”å®šï¼Œè¯·å…ˆè§£é”ç¼–è¾‘", "error");
        hideContextMenu();
        return;
      }

      showStatusMessage("æ­£åœ¨è‡ªåŠ¨åŠ è½½æºæ–‡ä»¶...", "info");

      fetch(SOURCE_FILE_URL)
        .then(response => {
          if (!response.ok) throw new Error(`ç½‘ç»œå“åº”ä¸æ­£å¸¸: ${response.status}`);
          return response.arrayBuffer();
        })
        .then(data => {
          processFileData(data);
          showStatusMessage("æºæ–‡ä»¶è‡ªåŠ¨åŠ è½½æˆåŠŸï¼", "success");
        })
        .catch(error => {
          console.error('åŠ è½½æºæ–‡ä»¶å¤±è´¥:', error);
          showStatusMessage(`åŠ è½½å¤±è´¥: ${error.message}`, "error");

          // 3ç§’åæ˜¾ç¤ºæ‰‹åŠ¨é€‰æ‹©æç¤º
          setTimeout(() => {
            if (confirm('è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œæ˜¯å¦æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶ï¼Ÿ')) {
              document.getElementById('upload').click();
            }
          }, 3000);
        })
        .finally(() => {
          hideContextMenu();
        });
    }
    // éœ€è¦æ·»åŠ è¿™ä¸ªæ–°å‡½æ•°
    function showStatusMessage(message, type = 'info') {
      // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
      const existingMessage = document.getElementById('status-message');
      if (existingMessage) {
        existingMessage.remove();
      }

      // åˆ›å»ºæ–°æ¶ˆæ¯
      const messageElement = document.createElement('div');
      messageElement.id = 'status-message';
      messageElement.className = `status-message status-${type}`;
      messageElement.textContent = message;

      document.body.appendChild(messageElement);

      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        messageElement.style.opacity = '0';
        setTimeout(() => messageElement.remove(), 300);
      }, 3000);
    }
  </script>
</body>

</html>