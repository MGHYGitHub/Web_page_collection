<!--
********************************************************************************
*  ğŸ“Š CPK è®¡ç®—å·¥å…·
*  ä½œè€…: ELI_MORGAN
*  ç‰ˆæœ¬: 1.0.0
*  å‘å¸ƒæ—¥æœŸ: 2025-09-11
*  å®˜æ–¹ç½‘ç«™/æ¥æº: https://github.com/MGHYGitHub/Web_page_collection
*  é˜²ä¼ªæ ‡è¯†: CPK-20250911-MGHY
*  è¯´æ˜: æœ¬å·¥å…·ç”¨äº Excel/CSV æ•°æ®çš„ CPK åˆ†æä¸å¯è§†åŒ–ï¼Œ
*        ç¦æ­¢æœªç»æˆæƒçš„å¤åˆ¶æˆ–åˆ†å‘ã€‚
********************************************************************************
-->
<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>CPK è®¡ç®—å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f7f9fc;
        }

        #footerInfo {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 20px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .upload-box {
            text-align: center;
            margin-bottom: 15px;
        }

        input[type="file"] {
            padding: 8px 12px;
            border: 2px solid #4e73df;
            border-radius: 8px;
            cursor: pointer;
            background: #fff;
            transition: 0.3s;
        }

        input[type="file"]:hover {
            background: #4e73df;
            color: #fff;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #e3e6f0;
            padding: 10px;
            text-align: center;
        }

        th {
            background: #4e73df;
            color: #fff;
        }

        tr:nth-child(even) {
            background: #f8f9fc;
        }

        canvas {
            max-width: 100%;
            height: 400px;
        }

        .button-container {
            text-align: center;
            margin: 20px 0;
        }

        .button-container button {
            padding: 10px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        #generateChartsBtn {
            background: #4CAF50;
            color: white;
        }

        #toggleParamChartBtn {
            background: #2196F3;
            color: white;
        }

        #toggleValidBtn {
            background: #FF9800;
            color: white;
        }
    </style>
</head>

<body>
    <h2>ğŸ“Š CPK è®¡ç®—å·¥å…·</h2>
    <div class="upload-box">
        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" />
    </div>

    <div id="result" class="card"></div>

    <div class="button-container">
        <button id="generateChartsBtn">ğŸ“Š ç”Ÿæˆç»Ÿè®¡å›¾</button>
        <button id="toggleParamChartBtn">ğŸ”„ å‚æ•°æ³¢åŠ¨å›¾</button>
        <button id="toggleValidBtn">åˆ‡æ¢æœ‰æ•ˆ/æºæ•°æ®æ˜¾ç¤º</button>
        <span id="validModeLabel" style="margin-left:10px; font-weight:bold; color:#e74a3b;">å½“å‰æ¨¡å¼ï¼šæœ‰æ•ˆæ•°æ®</span>
    </div>
    <div class="button-container">
        <button id="exportDataChartBtn">å¯¼å‡ºæ•°æ®è¶‹åŠ¿å›¾ (PNG)</button>
        <button id="exportCpkChartBtn">å¯¼å‡º CP/CPK å›¾ (PNG)</button>
        <button id="exportFailChartBtn">å¯¼å‡ºè¶…æ ‡ç‡å›¾ (PNG)</button>
    </div>


    <div id="chartsContainer" style="display:none;">
        <div class="card">
            <h3 style="text-align:center; color:#444;">æ•°æ®è¶‹åŠ¿è§†å›¾ï¼ˆå‡å€¼ã€ä¸Šä¸‹é™ã€æå€¼ï¼‰</h3>
            <canvas id="dataChart"></canvas>
        </div>
        <div class="card">
            <h3 style="text-align:center; color:#444;">CP / CPK è¶‹åŠ¿å›¾</h3>
            <canvas id="cpkChart"></canvas>
        </div>
        <div class="card">
            <h3 style="text-align:center; color:#444;">è¶…æ ‡ç‡ (%)</h3>
            <canvas id="failChart"></canvas>
        </div>
    </div>

    <div id="paramChartContainer" class="card" style="display:none;">
        <label for="paramSelect" style="font-weight:bold;">é€‰æ‹©å‚æ•°ï¼š</label>
        <select id="paramSelect" style="padding:6px 10px;border-radius:6px;border:1px solid #ccc;"></select>
        <div style="margin-top:20px;">
            <canvas id="paramTrendChart"></canvas>
        </div>
    </div>
    <div id="footerInfo">
        ä½œè€…: ELI_MORGAN | ç‰ˆæœ¬: 1.0.0 | é˜²ä¼ªæ ‡è¯†: CPK-20250911-MGHY
    </div>

    <script>
        let dataChartInstance = null, cpkChartInstance = null, failChartInstance = null, paramTrendChart = null;
        let rawData = [], columns = [];
        let useValidData = true;

        // æ–‡ä»¶å¯¼å…¥
        document.getElementById("excelFile").addEventListener("change", handleFile, false);
        function handleFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                rawData = jsonData.slice(1).map(r => { let obj = {}; jsonData[0].forEach((h, i) => { obj[h] = r[i]; }); return obj; });
                columns = jsonData[0];
                processData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function processData(data) {
            const headers = data[0], rows = data.slice(1);
            let result = `<table><tr><th>å‚æ•°</th><th>è§„æ ¼</th><th>ä¸Šé™</th><th>ä¸‹é™</th>
      <th>æœ€å¤§å€¼</th><th>æœ€å°å€¼</th><th>å¹³å‡å€¼</th><th>æ ‡å‡†å·®</th>
      <th>CP</th><th>CPK</th><th>è¶…æ ‡æ•°</th><th>è¶…æ ‡ç‡</th>
      <th>æœ‰æ•ˆæ•°</th><th>æ— æ•ˆæ•°</th></tr>`;

            let chartLabels = [], cpData = [], cpkData = [], failRateData = [], outOfSpecData = [];
            let meanData = [], uslData = [], lslData = [], maxData = [], minData = [];
            window.paramValues = [];

            for (let col = 2; col < headers.length; col++) {
                const specText = headers[col];
                const match = specText.match(/([-]?\d+\.?\d*)\s*Â±\s*(\d+\.?\d*)/);
                if (!match) continue;
                const target = parseFloat(match[1]), tol = parseFloat(match[2]);
                const USL = target + tol, LSL = target - tol;

                const valuesAll = rows.map(r => parseFloat(r[col])).filter(v => !isNaN(v));
                const valuesValid = valuesAll.filter(v => Math.abs(v - target) <= tol * 3);
                const invalidCount = valuesAll.length - valuesValid.length;
                const dataToUse = useValidData ? valuesValid : valuesAll;

                const maxVal = Math.max(...dataToUse);
                const minVal = Math.min(...dataToUse);
                const mean = dataToUse.reduce((a, b) => a + b, 0) / dataToUse.length;
                const std = Math.sqrt(dataToUse.reduce((a, b) => a + (b - mean) ** 2, 0) / (dataToUse.length - 1));
                const CP = (USL - LSL) / (6 * std);
                const Cpk1 = (USL - mean) / (3 * std), Cpk2 = (mean - LSL) / (3 * std), CPK = Math.min(Cpk1, Cpk2);
                const outOfSpec = dataToUse.filter(v => v > USL || v < LSL).length;
                const outRate = (outOfSpec / dataToUse.length) * 100;

                result += `<tr>
                    <td>${specText}</td><td>${target}Â±${tol}</td><td>${USL.toFixed(2)}</td><td>${LSL.toFixed(2)}</td>
                    <td>${maxVal}</td><td>${minVal}</td><td>${mean.toFixed(2)}</td><td>${std.toFixed(2)}</td>
                    <td>${CP.toFixed(3)}</td><td>${CPK.toFixed(3)}</td>
                    <td>${outOfSpec}</td><td>${outRate.toFixed(2)}%</td>
                    <td>${valuesValid.length}</td><td>${invalidCount}</td></tr>`;

                chartLabels.push(specText);
                cpData.push(CP.toFixed(3));
                cpkData.push(CPK.toFixed(3));
                failRateData.push(outRate.toFixed(2));
                outOfSpecData.push(outOfSpec);
                meanData.push(mean.toFixed(2));
                uslData.push(USL.toFixed(2));
                lslData.push(LSL.toFixed(2));
                maxData.push(maxVal);
                minData.push(minVal);

                window.paramValues.push(valuesAll);
            }
            result += "</table>";
            document.getElementById("result").innerHTML = result;

            window.chartData = { labels: chartLabels, cpData, cpkData, failRateData, outOfSpecData, meanData, uslData, lslData, maxData, minData };
        }


        // ç”Ÿæˆç»Ÿè®¡å›¾
        document.getElementById("generateChartsBtn").addEventListener("click", function () {
            document.getElementById("chartsContainer").style.display = "block";
            renderDataChart(window.chartData.labels, window.chartData.meanData, window.chartData.uslData, window.chartData.lslData, window.chartData.maxData, window.chartData.minData);
            renderCpkChart(window.chartData.labels, window.chartData.cpData, window.chartData.cpkData);
            renderFailChart(
                window.chartData.labels,
                window.chartData.failRateData,
                window.chartData.outOfSpecData  // éœ€è¦åœ¨ processData ä¸­ä¿å­˜æ¯ä¸ªå‚æ•°çš„è¶…æ ‡æ•°é‡
            );

        });

        // å‚æ•°æ³¢åŠ¨å›¾åˆ‡æ¢
        document.getElementById("toggleParamChartBtn").addEventListener("click", function () {
            const container = document.getElementById("paramChartContainer");
            container.style.display = (container.style.display === "none") ? "block" : "none";
            if (container.style.display === "block") initParamSelect();
        });

        function initParamSelect() {
            const paramSelect = document.getElementById("paramSelect");
            paramSelect.innerHTML = "";
            columns.forEach(col => {
                if (col !== columns[0] && col !== columns[1]) {
                    const option = document.createElement("option");
                    option.value = col; option.textContent = col;
                    paramSelect.appendChild(option);
                }
            });
            if (paramSelect.options.length > 0) renderParamTrend(paramSelect.value);
            paramSelect.addEventListener("change", function () { renderParamTrend(this.value); });
        }

        function renderParamTrend(paramName) {
            const ctx = document.getElementById("paramTrendChart").getContext("2d");
            const labels = rawData.map(r => r[columns[0]]);
            const valuesAll = rawData.map(r => parseFloat(r[paramName]));
            const values = valuesAll.map(v => isNaN(v) ? null : v);
            const match = paramName.match(/([-]?\d+\.?\d*)\s*Â±\s*(\d+\.?\d*)/);
            const target = match ? parseFloat(match[1]) : 0;
            const tol = match ? parseFloat(match[2]) : 0;
            const USL = target + tol, LSL = target - tol;

            if (paramTrendChart) paramTrendChart.destroy();
            paramTrendChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [
                        { label: paramName + " æ³¢åŠ¨", data: values, borderColor: "#FF5722", backgroundColor: "rgba(255,87,34,0.2)", fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: "#FF5722" },
                        { label: "ä¸Šé™ (USL)", data: new Array(labels.length).fill(USL), borderColor: "#e74a3b", borderDash: [6, 6], fill: false, pointRadius: 0 },
                        { label: "ä¸‹é™ (LSL)", data: new Array(labels.length).fill(LSL), borderColor: "#e74a3b", borderDash: [6, 6], fill: false, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: "index", intersect: false },
                    plugins: { legend: { display: true }, tooltip: { mode: 'index' } },
                    scales: { x: { title: { display: true, text: "SN" } }, y: { title: { display: true, text: "æ•°å€¼" } } }
                }
            });
        }

        // æ•°æ®è¶‹åŠ¿å›¾
        function renderDataChart(labels, meanData, uslData, lslData, maxData, minData) {
            const ctx = document.getElementById("dataChart").getContext("2d");
            if (dataChartInstance) dataChartInstance.destroy();
            dataChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels, datasets: [
                        { label: "å¹³å‡å€¼", data: meanData, borderColor: "#4e73df", backgroundColor: "rgba(78,115,223,0.1)", fill: false, tension: 0.2 },
                        { label: "ä¸Šé™ (USL)", data: uslData, borderColor: "#e74a3b", borderDash: [6, 6], fill: false, pointRadius: 0 },
                        { label: "ä¸‹é™ (LSL)", data: lslData, borderColor: "#e74a3b", borderDash: [6, 6], fill: false, pointRadius: 0 },
                        { label: "æœ€å¤§å€¼", data: maxData, borderColor: "#1cc88a", type: "scatter", pointStyle: "triangle", pointRadius: 6, showLine: false },
                        { label: "æœ€å°å€¼", data: minData, borderColor: "#f6c23e", type: "scatter", pointStyle: "rect", pointRadius: 6, showLine: false }
                    ]
                },
                options: { responsive: true, interaction: { mode: "index", intersect: false }, plugins: { legend: { position: "top" } } }
            });
        }

        // CP/CPKå›¾
        function renderCpkChart(labels, cpData, cpkData) {
            const ctx = document.getElementById("cpkChart").getContext("2d");
            if (cpkChartInstance) cpkChartInstance.destroy();
            cpkChartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels, datasets: [
                        { label: "CP", data: cpData, borderColor: "#1cc88a", fill: false, tension: 0.2 },
                        { label: "CPK", data: cpkData, borderColor: "#4e73df", fill: false, tension: 0.2 },
                        { label: "è­¦æˆ’çº¿ (1.33)", data: new Array(labels.length).fill(1.33), borderColor: "#e74a3b", borderDash: [6, 6], fill: false, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, interaction: { mode: "index", intersect: false }, plugins: { legend: { position: "top" } } }
            });
        }

        // è¶…æ ‡ç‡
        function renderFailChart(labels, failData, outCountData) {
            const ctx = document.getElementById("failChart").getContext("2d");
            if (failChartInstance) failChartInstance.destroy();

            failChartInstance = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "è¶…æ ‡ç‡ (%)",
                        data: failData,
                        backgroundColor: "#f6c23e"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#444',
                            font: { weight: 'bold' },
                            formatter: function (value, context) {
                                // æ˜¾ç¤ºå¯¹åº”çš„è¶…æ ‡æ•°é‡
                                return outCountData[context.dataIndex];
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `è¶…æ ‡ç‡: ${context.raw}% , æ•°é‡: ${outCountData[context.dataIndex]}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "è¶…æ ‡ç‡ (%)" }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }


        // æœ‰æ•ˆ/æºæ•°æ®åˆ‡æ¢
        document.getElementById("toggleValidBtn").addEventListener("click", function () {
            useValidData = !useValidData;
            const label = document.getElementById("validModeLabel");

            if (useValidData) {
                this.textContent = "åˆ‡æ¢æœ‰æ•ˆ/æºæ•°æ®æ˜¾ç¤º";
                label.textContent = "å½“å‰æ¨¡å¼ï¼šæœ‰æ•ˆæ•°æ®";
                label.style.color = "#1cc88a";
            } else {
                this.textContent = "åˆ‡æ¢æº/æœ‰æ•ˆæ•°æ®æ˜¾ç¤º";
                label.textContent = "å½“å‰æ¨¡å¼ï¼šåŒ…å«æ— æ•ˆæ•°æ®";
                label.style.color = "#e74a3b";
            }

            // é‡æ–°å¤„ç†è¡¨æ ¼å’Œå›¾è¡¨
            processData([columns, ...rawData.map(r => columns.map(h => r[h]))]);

            if (document.getElementById("chartsContainer").style.display === "block") {
                const chartData = window.chartData; // è·å–å…¨å±€æ•°æ®
                renderDataChart(chartData.labels, chartData.meanData, chartData.uslData, chartData.lslData, chartData.maxData, chartData.minData);
                renderCpkChart(chartData.labels, chartData.cpData, chartData.cpkData);
                renderFailChart(chartData.labels, chartData.failRateData, chartData.outOfSpecData);
            }
        });
        // é˜²ä¼ªæ ‡è¯†è¾“å‡º
        console.log(`
            **********************************************
            ğŸ“Š CPK è®¡ç®—å·¥å…·
            ä½œè€…: 
            ç‰ˆæœ¬: 1.0.0
            é˜²ä¼ªæ ‡è¯†: CPK-20250911-MGHY
            **********************************************
            `);
        function downloadChart(chartInstance, fileName) {
            if (!chartInstance) return alert("å›¾è¡¨æœªç”Ÿæˆï¼");
            const link = document.createElement('a');
            link.href = chartInstance.toBase64Image();
            link.download = fileName;
            link.click();
        }

        document.getElementById("exportDataChartBtn").addEventListener("click", function () {
            downloadChart(dataChartInstance, "æ•°æ®è¶‹åŠ¿å›¾.png");
        });

        document.getElementById("exportCpkChartBtn").addEventListener("click", function () {
            downloadChart(cpkChartInstance, "CP_CPKå›¾.png");
        });

        document.getElementById("exportFailChartBtn").addEventListener("click", function () {
            downloadChart(failChartInstance, "è¶…æ ‡ç‡å›¾.png");
        });
    </script>
</body>

</html>