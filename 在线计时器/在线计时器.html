<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§åœ¨çº¿è®¡æ—¶å™¨</title>
    <link rel="icon" type="image/x-icon" href="../icons/jsq.ico">
    <style>
        :root {
            --bg-color: #e0f7fa;
            --text-color: #00796b;
            --accent-color: #42a5f5;
            --card-bg: #ffffff;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --accent-color: #bb86fc;
            --card-bg: #2d2d2d;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        #top-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 12px;
            /* ç»Ÿä¸€å†…è¾¹è· */
            font-size: 12px;
            /* ç»Ÿä¸€å­—ä½“å¤§å° */
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.3s;
            background-color: var(--accent-color);
            color: white;
            white-space: nowrap;
            /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
            flex-shrink: 0;
            /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }

        .control-btn:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        .control-btn.on {
            background-color: #4caf50;
        }

        /* æ¨¡å¼é€‰æ‹© */
        #mode-selector {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid var(--accent-color);
            background: transparent;
            color: var(--text-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: var(--accent-color);
            color: white;
        }

        /* è®¡æ—¶å™¨æ˜¾ç¤º */
        #timer {
            font-size: 48px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .control-button {
            padding: 12px 24px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 25px;
            background: linear-gradient(90deg, var(--accent-color), #478ed1);
            color: white;
            transition: all 0.3s;
        }

        .control-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* è®°å½•åŒºåŸŸ */
        #records {
            margin-top: 20px;
            width: 400px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
        }

        .record {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .record:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .record:last-child {
            border-bottom: none;
        }

        .index {
            font-weight: bold;
            color: var(--accent-color);
            margin-right: 10px;
            min-width: 20px;
        }

        .separator {
            margin: 0 5px;
            color: var(--accent-color);
        }

        .time {
            font-size: 14px;
            color: var(--text-color);
            margin-right: 10px;
            min-width: 80px;
        }

        .interval {
            font-size: 12px;
            color: #ff5722;
            margin-right: 10px;
            min-width: 60px;
            font-style: italic;
        }

        .remark {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 0 5px;
            font-size: 14px;
            color: var(--text-color);
            background: transparent;
        }

        /* ç»Ÿè®¡é¢æ¿ */
        #stats-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 200px;
        }

        .stat-item {
            margin: 8px 0;
            font-size: 14px;
        }

        /* é¢„è®¾è®¡æ—¶å™¨ */
        #preset-timers {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .preset-btn {
            padding: 8px 16px;
            border: 1px solid var(--accent-color);
            background: transparent;
            color: var(--text-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .preset-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        /* é¡¹ç›®åˆ†ç±» */
        #project-selector {
            margin: 10px 0;
        }

        #project-select {
            padding: 8px 12px;
            border: 1px solid var(--accent-color);
            border-radius: 5px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #top-controls {
                position: static;
                justify-content: center;
                margin-bottom: 20px;
            }

            #stats-panel {
                position: static;
                width: 100%;
                margin: 20px 0;
            }

            #timer {
                font-size: 36px;
            }

            #records {
                width: 100%;
            }
        }

        /* è¿·ä½ ç»Ÿè®¡é¢æ¿æ ·å¼ */
        .stats-mini {
            display: flex;
            align-items: center;
            gap: 12px;
            /* å‡å°‘é—´è· */
            background: var(--card-bg);
            padding: 6px 12px;
            /* å‡å°‘å†…è¾¹è· */
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin: 0 5px;
            /* æ·»åŠ å·¦å³è¾¹è· */
        }

        .stat-item-mini {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            /* è¿›ä¸€æ­¥å‡å°å­—ä½“ */
            line-height: 1.2;
            min-width: 35px;
            /* ç¡®ä¿æ¯ä¸ªé¡¹ç›®æœ‰æœ€å°å®½åº¦ */
        }

        .stat-label {
            color: #666;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .stat-item-mini span:last-child {
            color: var(--accent-color);
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .stats-mini {
                gap: 8px;
                padding: 6px 12px;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .stat-item-mini {
                font-size: 9px;
            }
        }

        @media (max-width: 480px) {
            .stats-mini {
                order: 0;
                width: auto;
                justify-content: space-around;
                margin-bottom: 0;
            }

            #top-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* å…¬å‘Šæ æ ·å¼ */
        .announcement-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            max-height: 80vh;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .announcement-panel.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: var(--accent-color);
            color: white;
        }

        .announcement-header h4 {
            margin: 0;
            font-size: 16px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .announcement-content {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .announcement-section {
            margin-bottom: 20px;
        }

        .announcement-section h5 {
            margin: 0 0 12px 0;
            color: var(--accent-color);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .shortcut-item:last-child {
            border-bottom: none;
        }

        .key {
            background: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .desc {
            font-size: 13px;
            color: var(--text-color);
        }

        .feature-list {
            margin: 0;
            padding-left: 16px;
            font-size: 13px;
            line-height: 1.5;
        }

        .feature-list li {
            margin-bottom: 6px;
            color: var(--text-color);
        }

        .announcement-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .announcement-toggle {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .announcement-toggle:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        /* å…¬å‘Šæ è§¦å‘æŒ‰é’® */
        #announcement-toggle-btn {
            background: #ff9800;
        }

        #announcement-toggle-btn:hover {
            background: #f57c00;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .announcement-panel {
                width: 90vw;
                right: 5vw;
                left: 5vw;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-100%);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }
    </style>
</head>

<body>
    <!-- å…¬å‘Šæ  -->
    <div id="announcement-panel" class="announcement-panel">
        <div class="announcement-header">
            <h4>ğŸ“¢ ä½¿ç”¨è¯´æ˜</h4>
            <button class="close-btn" onclick="toggleAnnouncement()">Ã—</button>
        </div>
        <div class="announcement-content">
            <div class="announcement-section">
                <h5>ğŸ¯ å¿«æ·é”®</h5>
                <div class="shortcut-item">
                    <span class="key">ç©ºæ ¼é”®</span>
                    <span class="desc">å¼€å§‹/æš‚åœè®¡æ—¶</span>
                </div>
                <div class="shortcut-item">
                    <span class="key">C é”®</span>
                    <span class="desc">æ·»åŠ è®¡æ•°è®°å½•</span>
                </div>
                <div class="shortcut-item">
                    <span class="key">M é”®</span>
                    <span class="desc">åˆ‡æ¢æ¯«ç§’æ˜¾ç¤º</span>
                </div>
                <div class="shortcut-item">
                    <span class="key">S é”®</span>
                    <span class="desc">å£°éŸ³å¼€å…³</span>
                </div>
                <div class="shortcut-item">
                    <span class="key">1/2/3 é”®</span>
                    <span class="desc">åˆ‡æ¢æ¨¡å¼</span>
                </div>
                <div class="shortcut-item">
                    <span class="key">Ctrl + R</span>
                    <span class="desc">é‡ç½®è®¡æ—¶å™¨</span>
                </div>
            </div>

            <div class="announcement-section">
                <h5>ğŸ“ åŸºæœ¬åŠŸèƒ½</h5>
                <ul class="feature-list">
                    <li>æ”¯æŒç§’è¡¨ã€å€’è®¡æ—¶ã€é—´éš”è®¡æ—¶ä¸‰ç§æ¨¡å¼</li>
                    <li>è‡ªåŠ¨ç»Ÿè®¡ä¼šè¯æ—¶é•¿å’Œæ¬¡æ•°</li>
                    <li>æ”¯æŒé¡¹ç›®åˆ†ç±»å’Œæ—¶é—´è®°å½•</li>
                    <li>æ•°æ®å¯¼å‡ºå’Œæœ¬åœ°ä¿å­˜</li>
                    <li>æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢</li>
                </ul>
            </div>

            <div class="announcement-section">
                <h5>ğŸ’¡ ä½¿ç”¨æŠ€å·§</h5>
                <ul class="feature-list">
                    <li>åŒå‡»è®°å½•å¤‡æ³¨å¯ç¼–è¾‘å†…å®¹</li>
                    <li>ä½¿ç”¨é¢„è®¾æŒ‰é’®å¿«é€Ÿè®¾ç½®å€’è®¡æ—¶</li>
                    <li>ç»Ÿè®¡é¢æ¿æ˜¾ç¤ºå·¥ä½œæ•ˆç‡åˆ†æ</li>
                    <li>æ”¯æŒå£°éŸ³åé¦ˆå’Œæµè§ˆå™¨é€šçŸ¥</li>
                </ul>
            </div>
        </div>
        <div class="announcement-footer">
            <button class="announcement-toggle" onclick="toggleAnnouncement()">
                ğŸ“‹ éšè—è¯´æ˜
            </button>
        </div>
    </div>

    <div id="top-controls">
        <button id="currentTimeBtn" class="control-btn">
            <span id="currentTime"></span>
        </button>
        <button id="exportBtn" class="control-btn">å¯¼å‡ºæ•°æ®</button>
        <button id="toggleMsBtn" class="control-btn">æ¯«ç§’ | <span id="msStatus">OFF</span></button>
        <button id="soundToggle" class="control-btn">ğŸ”Š å£°éŸ³</button>

        <!-- ç»Ÿè®¡ä¿¡æ¯é›†æˆåˆ°æ§åˆ¶æ  -->
        <div id="stats-mini" class="stats-mini">
            <div class="stat-item-mini">
                <span class="stat-label">æ€»æ—¶é•¿:</span>
                <span id="total-time-mini">00:00:00</span>
            </div>
            <div class="stat-item-mini">
                <span class="stat-label">ä¼šè¯:</span>
                <span id="session-count-mini">0</span>
            </div>
            <div class="stat-item-mini">
                <span class="stat-label">å¹³å‡:</span>
                <span id="avg-time-mini">00:00</span>
            </div>
            <div class="stat-item-mini">
                <span class="stat-label">æœ€é•¿:</span>
                <span id="longest-time-mini">00:00</span>
            </div>
        </div>

        <!-- å…¬å‘Šæ è§¦å‘æŒ‰é’® -->
        <button id="announcement-toggle-btn" class="control-btn" onclick="toggleAnnouncement()">
            ğŸ“¢ è¯´æ˜
        </button>

        <!-- ä¸»é¢˜åˆ‡æ¢ -->
        <button id="theme-toggle" class="control-btn">ğŸŒ™ æš—è‰²æ¨¡å¼</button>
    </div>

    <!-- æ¨¡å¼é€‰æ‹© -->
    <div id="mode-selector">
        <button class="mode-btn active" data-mode="stopwatch">ç§’è¡¨æ¨¡å¼</button>
        <button class="mode-btn" data-mode="countdown">å€’è®¡æ—¶</button>
        <button class="mode-btn" data-mode="interval">é—´éš”è®¡æ—¶</button>
    </div>

    <!-- é¡¹ç›®åˆ†ç±» -->
    <div id="project-selector">
        <select id="project-select">
            <option value="work">å·¥ä½œ</option>
            <option value="study">å­¦ä¹ </option>
            <option value="sports">è¿åŠ¨</option>
            <option value="other">å…¶ä»–</option>
        </select>
    </div>

    <!-- é¢„è®¾è®¡æ—¶å™¨ -->
    <div id="preset-timers">
        <button class="preset-btn" data-time="300000">5åˆ†é’Ÿ</button>
        <button class="preset-btn" data-time="900000">15åˆ†é’Ÿ</button>
        <button class="preset-btn" data-time="1800000">30åˆ†é’Ÿ</button>
        <button class="preset-btn" data-time="2700000">45åˆ†é’Ÿ</button>
        <button class="preset-btn" data-time="3600000">60åˆ†é’Ÿ</button>
    </div>

    <div id="timer">00:00:00</div>

    <!-- å€’è®¡æ—¶è¾“å…¥ -->
    <div id="countdown-input" style="display: none; margin: 10px 0;">
        <input type="number" id="minutes-input" placeholder="åˆ†é’Ÿ" min="0" style="width: 80px; padding: 8px;">
        <input type="number" id="seconds-input" placeholder="ç§’" min="0" max="59" style="width: 80px; padding: 8px;">
        <button class="control-button" onclick="setCountdown()">è®¾ç½®</button>
    </div>

    <button class="control-button" id="startBtn">å¼€å§‹</button>
    <button class="control-button" id="pauseBtn" style="display:none;">æš‚åœ</button>
    <button class="control-button" id="resetBtn">é‡ç½®</button>
    <button class="control-button" id="countBtn" style="display:none;">è®¡æ•°</button>

    <div id="records"></div>

    <script>
        // é…ç½®å’ŒçŠ¶æ€ç®¡ç†
        const CONFIG = {
            sounds: {
                start: 'https://assets.mixkit.co/active_storage/sfx/286/286-preview.mp3',
                pause: 'https://assets.mixkit.co/active_storage/sfx/257/257-preview.mp3',
                count: 'https://assets.mixkit.co/active_storage/sfx/250/250-preview.mp3',
                complete: 'https://assets.mixkit.co/active_storage/sfx/269/269-preview.mp3'
            },
            themes: {
                light: {
                    '--bg-color': '#e0f7fa',
                    '--text-color': '#00796b',
                    '--accent-color': '#42a5f5',
                    '--card-bg': '#ffffff'
                },
                dark: {
                    '--bg-color': '#1a1a1a',
                    '--text-color': '#ffffff',
                    '--accent-color': '#bb86fc',
                    '--card-bg': '#2d2d2d'
                }
            }
        };

        const MODES = {
            STOPWATCH: 'stopwatch',
            COUNTDOWN: 'countdown',
            INTERVAL: 'interval'
        };

        // å…¨å±€çŠ¶æ€
        let state = {
            timerInterval: null,
            milliseconds: 0,
            countdownTime: 0,
            isRunning: false,
            recordCount: 0,
            showMilliseconds: false,
            lastRecordTime: 0,
            currentMode: MODES.STOPWATCH,
            soundEnabled: true,
            currentProject: 'work',
            stats: {
                totalTime: 0,
                sessionCount: 0,
                avgSessionTime: 0,
                longestSession: 0
            },
            sessions: []
        };

        // éŸ³é¢‘ä¸Šä¸‹æ–‡
        let audioContext = null;

        // åˆå§‹åŒ–
        function init() {
            loadSettings();
            setupEventListeners();
            updateCurrentTime();
            updateStats();
            setupAudio();

            // è‡ªåŠ¨æ˜¾ç¤ºå…¬å‘Šæ ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
            const firstTime = !localStorage.getItem('announcementShown');
            if (firstTime) {
                setTimeout(() => {
                    toggleAnnouncement();
                    localStorage.setItem('announcementShown', 'true');
                }, 1000);
            }

            // è®¾ç½®å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // æ£€æŸ¥å¿«æ·é”®æ˜¯å¦ç»‘å®šæˆåŠŸ
            console.log('å¿«æ·é”®ç»‘å®šçŠ¶æ€:', {
                space: 'å¼€å§‹/æš‚åœ',
                c: 'è®¡æ•°',
                m: 'æ¯«ç§’åˆ‡æ¢',
                s: 'å£°éŸ³å¼€å…³',
                '1/2/3': 'æ¨¡å¼åˆ‡æ¢',
                'ctrl+r': 'é‡ç½®'
            });

            setInterval(updateCurrentTime, 1000);
        }

        function setupAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡ä¸æ”¯æŒ');
            }
        }

        function playSound(type) {
            if (!state.soundEnabled || !audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            let frequency = 440;
            switch (type) {
                case 'start': frequency = 523; break; // C5
                case 'pause': frequency = 392; break; // G4
                case 'count': frequency = 659; break; // E5
                case 'complete': frequency = 784; break; // G5
            }

            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function handleKeyboardShortcuts(event) {
            // æ’é™¤è¾“å…¥æ¡†
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') {
                return;
            }

            // é˜²æ­¢é»˜è®¤è¡Œä¸º
            event.preventDefault();

            switch (event.code) {
                case 'Space':
                    console.log('ç©ºæ ¼é”®æŒ‰ä¸‹ - åˆ‡æ¢è®¡æ—¶å™¨');
                    toggleTimer();
                    break;
                case 'KeyR':
                    if (event.ctrlKey) {
                        console.log('Ctrl+R æŒ‰ä¸‹ - é‡ç½®');
                        resetTimer();
                    } else {
                        console.log('Ré”®æŒ‰ä¸‹ - æ·»åŠ è®°å½•');
                        addRecord();
                    }
                    break;
                case 'KeyC':
                    console.log('Cé”®æŒ‰ä¸‹ - æ·»åŠ è®°å½•');
                    addRecord();
                    break;
                case 'KeyM':
                    console.log('Mé”®æŒ‰ä¸‹ - åˆ‡æ¢æ¯«ç§’');
                    toggleMilliseconds();
                    break;
                case 'KeyS':
                    console.log('Sé”®æŒ‰ä¸‹ - åˆ‡æ¢å£°éŸ³');
                    toggleSound();
                    break;
                case 'Digit1':
                    console.log('1é”®æŒ‰ä¸‹ - åˆ‡æ¢åˆ°ç§’è¡¨æ¨¡å¼');
                    switchMode(MODES.STOPWATCH);
                    break;
                case 'Digit2':
                    console.log('2é”®æŒ‰ä¸‹ - åˆ‡æ¢åˆ°å€’è®¡æ—¶æ¨¡å¼');
                    switchMode(MODES.COUNTDOWN);
                    break;
                case 'Digit3':
                    console.log('3é”®æŒ‰ä¸‹ - åˆ‡æ¢åˆ°é—´éš”è®¡æ—¶æ¨¡å¼');
                    switchMode(MODES.INTERVAL);
                    break;
            }
        }

        function toggleTimer() {
            if (state.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const milli = Math.floor((ms % 1000) / 10);

            if (state.showMilliseconds) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milli).padStart(2, '0')}`;
            } else {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        function formatInterval(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}min${seconds}s`;
        }

        function updateDisplay() {
            let displayTime = state.milliseconds;

            if (state.currentMode === MODES.COUNTDOWN) {
                displayTime = Math.max(0, state.countdownTime - state.milliseconds);
                if (displayTime === 0 && state.isRunning) {
                    timerComplete();
                }
            }

            document.getElementById('timer').innerText = formatTime(displayTime);

            // å€’è®¡æ—¶è­¦å‘Š
            if (state.currentMode === MODES.COUNTDOWN && displayTime < 30000 && displayTime > 0) {
                document.getElementById('timer').style.color = '#ff4444';
            } else {
                document.getElementById('timer').style.color = '';
            }
        }

        function startTimer() {
            if (state.currentMode === MODES.COUNTDOWN && state.countdownTime === 0) {
                alert('è¯·å…ˆè®¾ç½®å€’è®¡æ—¶æ—¶é—´');
                return;
            }

            state.isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('countBtn').style.display = 'inline-block';

            const startTime = Date.now() - state.milliseconds;

            function tick() {
                if (state.isRunning) {
                    state.milliseconds = Date.now() - startTime;
                    updateDisplay();
                    setTimeout(tick, 10);
                }
            }

            tick();
            playSound('start');

            // è®°å½•ä¼šè¯å¼€å§‹
            state.sessions.push({
                startTime: new Date(),
                project: state.currentProject,
                mode: state.currentMode
            });
        }

        function pauseTimer() {
            state.isRunning = false;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').innerText = 'ç»§ç»­';
            document.getElementById('startBtn').style.display = 'inline-block';
            playSound('pause');

            // æ›´æ–°ä¼šè¯ç»Ÿè®¡
            if (state.sessions.length > 0) {
                const currentSession = state.sessions[state.sessions.length - 1];
                currentSession.endTime = new Date();
                currentSession.duration = state.milliseconds;
                updateStats();
            }
        }

        function resetTimer() {
            clearInterval(state.timerInterval);
            state.milliseconds = 0;
            state.recordCount = 0;
            state.lastRecordTime = 0;
            updateDisplay();
            state.isRunning = false;
            document.getElementById('countBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').innerText = 'å¼€å§‹';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('records').innerHTML = '';
            document.getElementById('timer').style.color = '';
        }

        function addRecord() {
            const recordsDiv = document.getElementById('records');
            const recordDiv = document.createElement('div');
            recordDiv.className = 'record';
            state.recordCount++;
            const timeText = formatTime(state.milliseconds);

            let intervalText = '';
            if (state.recordCount > 1) {
                const intervalMs = state.milliseconds - state.lastRecordTime;
                intervalText = formatInterval(intervalMs);
            } else {
                intervalText = 'é¦–æ¬¡è®°å½•';
            }
            state.lastRecordTime = state.milliseconds;

            recordDiv.innerHTML = `
                <div class="index">${state.recordCount}</div>
                <div class="separator">|</div>
                <div class="time">${timeText}</div>
                <div class="interval">${intervalText}</div>
                <input class="remark" placeholder="è¾“å…¥å¤‡æ³¨..." onkeydown="if(event.key==='Enter') this.blur()" ondblclick="this.readOnly=false">
            `;

            recordsDiv.appendChild(recordDiv);
            recordsDiv.scrollTop = recordsDiv.scrollHeight;
            playSound('count');
        }

        function toggleMilliseconds() {
            state.showMilliseconds = !state.showMilliseconds;
            const toggleBtn = document.getElementById('toggleMsBtn');
            const msStatus = document.getElementById('msStatus');
            if (state.showMilliseconds) {
                toggleBtn.classList.add('on');
                msStatus.innerText = 'ON';
            } else {
                toggleBtn.classList.remove('on');
                msStatus.innerText = 'OFF';
            }
            updateDisplay();
        }

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            const soundBtn = document.getElementById('soundToggle');
            soundBtn.innerHTML = state.soundEnabled ? 'ğŸ”Š å£°éŸ³' : 'ğŸ”‡ é™éŸ³';
        }

        function switchMode(mode, event) {  // æ·»åŠ  event å‚æ•°
            state.currentMode = mode;
            resetTimer();

            // æ›´æ–°UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ç¡®ä¿ event å­˜åœ¨å†ä½¿ç”¨
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // å¦‚æœæ²¡æœ‰ eventï¼Œé€šè¿‡ dataset æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®
                const targetBtn = document.querySelector(`.mode-btn[data-mode="${mode}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            }

            // æ˜¾ç¤º/éšè—ç›¸å…³æ§ä»¶
            const countdownInput = document.getElementById('countdown-input');
            countdownInput.style.display = mode === MODES.COUNTDOWN ? 'block' : 'none';
        }

        function setCountdown() {
            const minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            const seconds = parseInt(document.getElementById('seconds-input').value) || 0;
            state.countdownTime = (minutes * 60 + seconds) * 1000;
            updateDisplay();
        }

        function setPresetTimer(time) {
            state.countdownTime = parseInt(time);
            document.getElementById('minutes-input').value = Math.floor(state.countdownTime / 60000);
            document.getElementById('seconds-input').value = Math.floor((state.countdownTime % 60000) / 1000);
            updateDisplay();
        }

        function timerComplete() {
            state.isRunning = false;
            playSound('complete');
            alert('å€’è®¡æ—¶ç»“æŸï¼');
            resetTimer();

            // æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('è®¡æ—¶å™¨', {
                    body: 'å€’è®¡æ—¶å·²ç»“æŸï¼',
                    icon: '../icons/jsq.ico'
                });
            }
        }

        function updateStats() {
            // æ›´æ–°æ€»æ—¶é—´
            state.stats.totalTime = state.sessions.reduce((total, session) => total + (session.duration || 0), 0);

            // æ›´æ–°ä¼šè¯æ•°
            state.stats.sessionCount = state.sessions.length;

            // æ›´æ–°å¹³å‡æ—¶é•¿ï¼ˆé¿å…é™¤ä»¥é›¶ï¼‰
            state.stats.avgSessionTime = state.stats.sessionCount > 0 ?
                state.stats.totalTime / state.stats.sessionCount : 0;

            // æ›´æ–°æœ€é•¿ä¼šè¯
            state.stats.longestSession = state.sessions.length > 0 ?
                Math.max(...state.sessions.map(s => s.duration || 0)) : 0;

            // æ›´æ–°è¿·ä½ ç»Ÿè®¡é¢æ¿æ˜¾ç¤º
            document.getElementById('total-time-mini').textContent = formatTimeShort(state.stats.totalTime);
            document.getElementById('session-count-mini').textContent = state.stats.sessionCount;
            document.getElementById('avg-time-mini').textContent = formatTimeShort(state.stats.avgSessionTime);
            document.getElementById('longest-time-mini').textContent = formatTimeShort(state.stats.longestSession);

            console.log('ç»Ÿè®¡æ›´æ–°:', state.stats);
        }

        function exportData() {
            const recordsDiv = document.getElementById('records');
            let content = `è®¡æ—¶è®°å½• (${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false })}):\n\n`;
            content += `æ¨¡å¼: ${state.currentMode}\n`;
            content += `é¡¹ç›®: ${document.getElementById('project-select').options[document.getElementById('project-select').selectedIndex].text}\n\n`;

            const records = recordsDiv.getElementsByClassName('record');
            for (let i = 0; i < records.length; i++) {
                const time = records[i].getElementsByClassName('time')[0].innerText;
                const interval = records[i].getElementsByClassName('interval')[0].innerText;
                const remark = records[i].getElementsByClassName('remark')[0].value || 'æ— å¤‡æ³¨';
                content += `è®°å½• ${i + 1}: ${time} (é—´éš”: ${interval}) - ${remark}\n`;
            }

            content += `\nç»Ÿè®¡ä¿¡æ¯:\n`;
            content += `æ€»è®¡æ—¶: ${formatTime(state.stats.totalTime)}\n`;
            content += `ä¼šè¯æ¬¡æ•°: ${state.stats.sessionCount}\n`;
            content += `å¹³å‡æ—¶é•¿: ${formatTime(state.stats.avgSessionTime)}\n`;
            content += `æœ€é•¿ä¼šè¯: ${formatTime(state.stats.longestSession)}\n`;

            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è®¡æ—¶è®°å½•_${new Date().toISOString().slice(0, 10)}.txt`;
            link.click();
        }
        // çŸ­æ—¶é—´æ ¼å¼æ˜¾ç¤ºï¼ˆå»æ‰å°æ—¶ï¼‰
        function formatTimeShort(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateCurrentTime() {
            const now = new Date();
            const beijingTime = now.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
            document.getElementById('currentTime').innerText = `${beijingTime}`;
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);

            const themeBtn = document.getElementById('theme-toggle');
            themeBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸ äº®è‰²æ¨¡å¼' : 'ğŸŒ™ æš—è‰²æ¨¡å¼';

            saveSettings();
        }

        function setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', startTimer);
            document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
            document.getElementById('resetBtn').addEventListener('click', resetTimer);
            document.getElementById('countBtn').addEventListener('click', addRecord);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('toggleMsBtn').addEventListener('click', toggleMilliseconds);
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchMode(e.target.dataset.mode, e));
            });

            // é¢„è®¾è®¡æ—¶å™¨
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => setPresetTimer(e.target.dataset.time));
            });

            // é¡¹ç›®é€‰æ‹©
            document.getElementById('project-select').addEventListener('change', (e) => {
                state.currentProject = e.target.value;
            });

            // è¯·æ±‚é€šçŸ¥æƒé™
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        }

        function saveSettings() {
            const settings = {
                theme: document.body.getAttribute('data-theme') || 'light',
                soundEnabled: state.soundEnabled,
                showMilliseconds: state.showMilliseconds,
                currentProject: state.currentProject
            };
            localStorage.setItem('timerSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('timerSettings') || '{}');

            if (settings.theme) {
                document.body.setAttribute('data-theme', settings.theme);
                const themeBtn = document.getElementById('theme-toggle');
                themeBtn.textContent = settings.theme === 'dark' ? 'â˜€ï¸ äº®è‰²æ¨¡å¼' : 'ğŸŒ™ æš—è‰²æ¨¡å¼';
            }

            if (settings.soundEnabled !== undefined) {
                state.soundEnabled = settings.soundEnabled;
                const soundBtn = document.getElementById('soundToggle');
                soundBtn.innerHTML = state.soundEnabled ? 'ğŸ”Š å£°éŸ³' : 'ğŸ”‡ é™éŸ³';
            }

            if (settings.showMilliseconds !== undefined) {
                state.showMilliseconds = settings.showMilliseconds;
                const msStatus = document.getElementById('msStatus');
                msStatus.innerText = state.showMilliseconds ? 'ON' : 'OFF';
                if (state.showMilliseconds) {
                    document.getElementById('toggleMsBtn').classList.add('on');
                }
            }

            if (settings.currentProject) {
                state.currentProject = settings.currentProject;
                document.getElementById('project-select').value = state.currentProject;
            }
        }

        // æ§åˆ¶å°é˜²ä¼ªä¿¡æ¯
        window.addEventListener('load', () => {
            console.log("%c====================================", "color: #888; font-size: 12px;");
            console.log("%cé«˜çº§è®¡æ—¶å™¨æ§åˆ¶å°", "color: white; background: #333; font-size: 18px; font-weight: bold; padding: 5px 15px; border-radius: 4px;");
            console.log("%cç‰ˆæœ¬ v4.0 - ä¸“ä¸šç‰ˆ", "color: white; background: #4CAF50; font-size: 16px; font-weight: bold; padding: 3px 10px; border-radius: 3px;");
            console.log("%cå¿«æ·é”®: ç©ºæ ¼=å¼€å§‹/æš‚åœ, C=è®¡æ•°, M=æ¯«ç§’åˆ‡æ¢", "color: #2196F3; font-size: 14px;");
            console.log("%c====================================", "color: #888; font-size: 12px;");

            init();
        });

        // å…¬å‘Šæ åŠŸèƒ½
        function toggleAnnouncement() {
            const panel = document.getElementById('announcement-panel');
            panel.classList.toggle('show');

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const toggleBtn = document.getElementById('announcement-toggle-btn');
            const footerBtn = document.querySelector('.announcement-toggle');

            if (panel.classList.contains('show')) {
                toggleBtn.innerHTML = 'ğŸ“¢ éšè—';
                footerBtn.textContent = 'ğŸ“‹ éšè—è¯´æ˜';
            } else {
                toggleBtn.innerHTML = 'ğŸ“¢ è¯´æ˜';
                footerBtn.textContent = 'ğŸ“‹ æ˜¾ç¤ºè¯´æ˜';
            }
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­å…¬å‘Šæ 
        document.addEventListener('click', function (event) {
            const panel = document.getElementById('announcement-panel');
            const toggleBtn = document.getElementById('announcement-toggle-btn');

            if (panel.classList.contains('show') &&
                !panel.contains(event.target) &&
                !toggleBtn.contains(event.target)) {
                toggleAnnouncement();
            }
        });

        // ESCé”®å…³é—­å…¬å‘Šæ 
        document.addEventListener('keydown', function (event) {
            if (event.code === 'Escape') {
                const panel = document.getElementById('announcement-panel');
                if (panel.classList.contains('show')) {
                    toggleAnnouncement();
                }
            }
        });
    </script>
</body>

</html>